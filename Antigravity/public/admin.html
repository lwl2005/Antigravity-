<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antigravity API 管理控制台</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- Login Overlay -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h2 style="margin-bottom: 8px; font-size: 24px; font-weight: 700;">管理控制台</h2>
            <p style="color: #6b7280; margin-bottom: 24px;">请输入密码以继续</p>
            <div class="form-group">
                <input type="password" id="loginPassword" placeholder="密码"
                    onkeypress="if(event.key==='Enter')doLogin()">
            </div>
            <button onclick="doLogin()" id="loginBtn2" style="width: 100%;">登录</button>
            <div id="loginError" class="login-error" style="color: #ef4444; margin-top: 12px; font-size: 14px;"></div>
        </div>
    </div>

    <div class="container">
        <div class="header header-gradient">
            <div>
                <h1>统一的大语言模型接口</h1>
                <p>更好的价格，更高的可用性，无需订阅。</p>
            </div>
            <div class="header-actions">
                <button onclick="doLogout()" class="btn btn-secondary"
                    style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;">退出登录</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('home')">首页</button>
            <button class="nav-tab" onclick="switchTab('tokens')">令牌管理</button>
            <button class="nav-tab" onclick="switchTab('keys')">API密钥</button>
            <button class="nav-tab" onclick="switchTab('test')">测试面板</button>
            <button class="nav-tab" onclick="switchTab('logs')">日志</button>
            <button class="nav-tab" onclick="switchTab('settings')">设置</button>
            <button class="nav-tab" onclick="switchTab('proxies')">代理管理</button>
            <button class="nav-tab" onclick="switchTab('pricing')">定价管理</button>
        </div>

        <!-- Home -->
        <div id="home" class="tab-content active">
            <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                <label class="auto-refresh">
                    <input type="checkbox" id="autoRefreshMonitor" onchange="toggleAutoRefresh('monitor')">
                    <span>自动刷新监控</span>
                </label>
            </div>

            <div class="status-grid">
                <div class="status-card">
                    <h3>服务状态</h3>
                    <div class="value" id="serviceStatus" style="color: #10b981;">运行中</div>
                </div>
                <div class="status-card">
                    <h3>活跃令牌</h3>
                    <div class="value" id="tokenCount">0</div>
                    <small style="color: #6b7280; display: block; margin-top: 4px;">已启用: <span
                            id="tokenEnabled">0</span> / 已禁用: <span id="tokenDisabled">0</span></small>
                </div>
                <div class="status-card">
                    <h3>API密钥</h3>
                    <div class="value" id="keyCount">0</div>
                    <small style="color: #6b7280; display: block; margin-top: 4px;">总请求数: <span
                            id="keyRequests">0</span></small>
                </div>
                <div class="status-card">
                    <h3>今日请求</h3>
                    <div class="value" id="todayRequests">0</div>
                </div>
                <div class="status-card">
                    <h3>CPU 使用率</h3>
                    <div class="value" id="cpuUsage">-</div>
                </div>
                <div class="status-card">
                    <h3>内存</h3>
                    <div class="value" id="memoryUsage">-</div>
                </div>
                <div class="status-card">
                    <h3>运行时间</h3>
                    <div class="value" id="uptime">-</div>
                </div>
                <div class="status-card">
                    <h3>总请求数</h3>
                    <div class="value" id="totalRequests">-</div>
                </div>
                <div class="status-card">
                    <h3>服务器状态</h3>
                    <div class="value" id="idleStatus" style="font-size: 24px;">-</div>
                    <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 5px;">空闲时间: <span
                            id="idleTime">0</span>秒</small>
                </div>
            </div>

            <div class="card">
                <h3>快速开始</h3>
                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <strong style="color: #4b5563;">API Base URL:</strong>
                    <code id="baseUrl" style="background: #fff; padding: 2px 6px; border-radius: 4px; margin-left: 8px; font-family: 'JetBrains Mono', monospace; color: #2563eb;">-</code>
                </div>
                <ol style="margin-left: 20px; color: #4b5563; line-height: 2;">
                    <li>前往<strong>令牌管理</strong>页面，使用 Google 登录。</li>
                    <li>前往<strong>API密钥</strong>页面，生成密钥。</li>
                    <li>使用<strong>测试面板</strong>测试 API。</li>
                </ol>
            </div>



            <div class="card">
                <h3>Token 监控</h3>
                <div id="tokenUsageStats">
                    <div style="text-align: center; color: #999; padding: 20px;">加载中...</div>
                </div>
            </div>

            <div class="card">
                <h3>系统信息</h3>
                <div id="systemInfo">加载中...</div>
            </div>

            <button onclick="loadMonitorData()" class="btn-secondary">刷新监控数据</button>
        </div>

        <!-- Tokens -->
        <div id="tokens" class="tab-content">
            <div class="card">
                <h3>添加令牌</h3>
                <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 300px; padding-right: 20px; border-right: 1px solid #eee;">
                        <h4>方法 1: Google OAuth 登录 (推荐)</h4>
                        <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9em;">点击下方按钮开始 Google OAuth 登录流程。</p>
                        <button onclick="triggerGoogleLogin()" id="loginBtn" class="btn-success" style="width: 100%;">使用 Google 登录</button>
                        <div id="loginResult" style="margin-top: 15px;"></div>
                    </div>

                    <div style="flex: 1; min-width: 300px;">
                        <h4>方法 2: 手动添加 (回调 URL)</h4>
                        <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9em;">如果自动回调失败，请在此处粘贴完整的回调 URL。</p>
                        <div class="form-group">
                            <input type="text" id="callbackUrl" placeholder="http://localhost:xxxx/oauth-callback?code=..." style="width: 100%;">
                        </div>
                        <button onclick="addTokenManually()" id="addTokenBtn" class="btn-secondary" style="width: 100%;">添加令牌</button>
                        <div id="addTokenResult" style="margin-top: 15px;"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">活跃令牌</h3>
                    <div class="flex-buttons">
                        <button onclick="selectAllTokens()" class="btn-secondary">全选</button>
                        <button onclick="exportSelectedTokens()" class="btn-warning">导出所选</button>
                        <button onclick="importTokens()" class="btn-success">导入 ZIP</button>
                        <button onclick="loadTokens()" class="btn-secondary">刷新</button>
                    </div>
                </div>
                <div id="tokenList">
                    <div style="text-align: center; color: #9ca3af; padding: 20px;">加载中...</div>
                </div>
            </div>
        </div>

        <!-- Keys -->
        <div id="keys" class="tab-content">
            <div class="card">
                <h3>生成新密钥</h3>
                <div class="form-group">
                    <label>密钥名称（可选）</label>
                    <input type="text" id="keyName" placeholder="例如：我的应用密钥">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="enableRateLimit" onchange="toggleRateLimitFields()"
                            style="width: auto;">
                        启用速率限制
                    </label>
                </div>
                <div id="rateLimitFields" style="display: none;">
                    <div class="form-group">
                        <label>最大请求数</label>
                        <input type="number" id="maxRequests" value="100" min="1" placeholder="100">
                    </div>
                    <div class="form-group">
                        <label>时间窗口（秒）</label>
                        <input type="number" id="windowSeconds" value="60" min="1" placeholder="60">
                    </div>
                </div>
                <div class="form-group">
                    <label>费用上限（美元）</label>
                    <input type="number" id="maxBalance" value="10" min="0" step="0.01" placeholder="10">
                    <small style="color: #6b7280; display: block; margin-top: 4px;">输入 -1 设置为无限额度</small>
                </div>
                <button onclick="generateKey()">生成密钥</button>
            </div>

            <div class="card">
                <h3>现有密钥</h3>
                <ul class="key-list" id="keyList">
                    <li style="text-align: center; color: #9ca3af;">未找到密钥</li>
                </ul>
            </div>
        </div>

        <!-- Test -->
        <div id="test" class="tab-content">
            <div class="card">
                <h3>测试面板</h3>
                <div id="chatMessages"></div>
                <div class="form-group">
                    <label>消息</label>
                    <textarea id="testMessage" placeholder="输入您的消息...">你好，你是谁？</textarea>
                </div>
                <div class="form-group">
                    <label>模型 <button onclick="loadModels()" class="btn-secondary"
                            style="padding: 4px 12px; font-size: 12px; margin-left: 10px;">刷新</button></label>
                    <select id="testModel">
                        <option value="">加载中...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>API 密钥</label>
                    <input type="text" id="testApiKey" placeholder="请输入您的 API 密钥">
                </div>
                <div class="flex-buttons">
                    <button onclick="sendTestMessage()" id="sendBtn">发送消息</button>
                    <button onclick="clearChat()" class="btn-secondary">清空对话</button>
                </div>
            </div>
        </div>


        <!-- Logs -->
        <div id="logs" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">实时日志</h3>
                    <label class="auto-refresh">
                        <input type="checkbox" id="autoRefreshLogs" onchange="toggleAutoRefresh('logs')">
                        <span>自动刷新</span>
                    </label>
                </div>
                <div class="flex-buttons">
                    <button onclick="loadLogs()" class="btn-secondary">刷新</button>
                    <button onclick="clearLogs()" class="btn-danger">清空日志</button>
                </div>
            </div>
            <div id="logContainer">
                <div style="text-align: center; color: #9ca3af; padding: 20px;">加载中...</div>
            </div>
        </div>



        <!-- Settings -->
        <div id="settings" class="tab-content">
            <div class="card">
                <h3>服务器配置</h3>
                <div class="form-group">
                    <label>端口</label>
                    <input type="number" id="settingPort" placeholder="8045">
                </div>
                <div class="form-group">
                    <label>主机</label>
                    <input type="text" id="settingHost" placeholder="0.0.0.0">
                </div>
            </div>

            <div class="card">
                <h3>安全设置</h3>
                <div class="form-group">
                    <label>默认 API 密钥</label>
                    <input type="text" id="settingApiKey" placeholder="sk-text">
                </div>
                <div class="form-group">
                    <label>管理员密码</label>
                    <input type="password" id="settingAdminPassword" placeholder="admin123">
                </div>
                <div class="form-group">
                    <label>最大请求大小</label>
                    <input type="text" id="settingMaxRequestSize" placeholder="50mb">
                </div>
            </div>

            <div class="card">
                <h3>模型默认参数</h3>
                <div class="form-group">
                    <label>温度</label>
                    <input type="number" id="settingTemperature" step="0.1" min="0" max="2" placeholder="1">
                </div>
                <div class="form-group">
                    <label>Top P</label>
                    <input type="number" id="settingTopP" step="0.01" min="0" max="1" placeholder="0.85">
                </div>
                <div class="form-group">
                    <label>Top K</label>
                    <input type="number" id="settingTopK" min="1" placeholder="50">
                </div>
                <div class="form-group">
                    <label>最大令牌数</label>
                    <input type="number" id="settingMaxTokens" min="1" placeholder="8096">
                </div>
            </div>

            <div class="card">
                <h3>系统指令</h3>
                <div class="form-group">
                    <label>系统指令</label>
                    <textarea id="settingSystemInstruction" rows="5"
                        placeholder="输入系统指令..."></textarea>
                </div>
            </div>

            <div class="flex-buttons">
                <button onclick="loadSettings()" class="btn-secondary">重新加载</button>
                <button onclick="saveSettings()" class="btn-success">保存设置</button>
            </div>
        </div>

        <!-- Proxies -->
        <div id="proxies" class="tab-content">
            <div class="card">
                <h3>添加代理</h3>
                <div class="form-group">
                    <label>快捷输入</label>
                    <input type="text" id="proxyQuickInput" placeholder="例如：socks5://user:pass@127.0.0.1:1080" onkeypress="if(event.key==='Enter')parseProxyUrl()">
                    <small style="color: #6b7280; display: block; margin-top: 4px;">支持格式：protocol://[username:password@]host:port（按回车键解析）</small>
                </div>
                <button onclick="parseProxyUrl()" class="btn-secondary" style="margin-bottom: 15px;">解析并填充</button>

                <div style="border-top: 1px solid #e5e7eb; padding-top: 15px; margin-top: 15px;">
                    <div class="form-group">
                        <label>代理名称</label>
                        <input type="text" id="proxyName" placeholder="例如：香港代理">
                    </div>
                    <div class="form-group">
                        <label>协议类型</label>
                        <select id="proxyProtocol">
                            <option value="socks5">SOCKS5</option>
                            <option value="socks4">SOCKS4</option>
                            <option value="http">HTTP</option>
                            <option value="https">HTTPS</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>主机地址</label>
                        <input type="text" id="proxyHost" placeholder="例如：127.0.0.1">
                    </div>
                    <div class="form-group">
                        <label>端口</label>
                        <input type="number" id="proxyPort" placeholder="例如：1080">
                    </div>
                    <div class="form-group">
                        <label>用户名（可选）</label>
                        <input type="text" id="proxyUsername" placeholder="留空表示无需认证">
                    </div>
                    <div class="form-group">
                        <label>密码（可选）</label>
                        <input type="password" id="proxyPassword" placeholder="留空表示无需认证">
                    </div>
                    <button onclick="addProxy()" class="btn-success">添加代理</button>
                </div>
            </div>

            <div class="card">
                <h3>代理列表</h3>
                <button onclick="testAllProxies()" class="btn-secondary" style="margin-bottom: 15px;">测试所有代理</button>
                <div id="proxyList">
                    <div style="text-align: center; color: #9ca3af; padding: 20px;">加载中...</div>
                </div>
            </div>
        </div>

        <!-- Pricing -->
        <div id="pricing" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h3 style="margin: 0;">Token定价管理</h3>
                        <p style="color: #6b7280; margin-top: 8px;">配置不同模型的输入/输出token价格（美元/百万tokens）</p>
                    </div>
                    <div class="flex-buttons">
                        <button onclick="showAddPricingModal()" class="btn-primary">添加模型</button>
                        <button onclick="loadPricing()" class="btn-secondary">刷新</button>
                        <button onclick="resetPricing()" class="btn-danger">重置默认</button>
                    </div>
                </div>
                <div id="pricingList">
                    <div style="text-align: center; color: #9ca3af; padding: 20px;">加载中...</div>
                </div>
            </div>

            <div class="card">
                <h3>定价说明</h3>
                <p style="color: #6b7280; line-height: 1.8;">
                    • <strong>动态定价</strong>: 可为每个模型设置独立的输入/输出token价格<br>
                    • <strong>默认定价</strong>: 未配置的模型将使用"default"定价<br>
                    • <strong>实时生效</strong>: 修改定价后立即对新请求生效<br>
                    • <strong>价格单位</strong>: 美元/百万tokens（$1.25 = 每百万tokens收费1.25美元）
                </p>
            </div>
        </div>
    </div>
    <script>
        const API_BASE = window.location.origin;
        let chatHistory = [];
        let autoRefreshIntervals = {};
        let adminToken = localStorage.getItem('adminToken') || '';

        // 获取带认证的 headers
        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'X-Admin-Token': adminToken
            };
        }

        // 登录
        async function doLogin() {
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            const btn = document.getElementById('loginBtn2');

            if (!password) {
                errorEl.textContent = '请输入密码';
                return;
            }

            btn.disabled = true;
            btn.textContent = '登录中...';
            errorEl.textContent = '';

            try {
                const response = await fetch(`${API_BASE}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    adminToken = data.token;
                    localStorage.setItem('adminToken', adminToken);
                    document.getElementById('loginOverlay').classList.add('hidden');
                    loadHomeData();
                } else {
                    errorEl.textContent = data.error || '登录失败';
                }
            } catch (error) {
                errorEl.textContent = '登录失败: ' + error.message;
            } finally {
                btn.disabled = false;
                btn.textContent = '登录';
            }
        }

        // 登出
        async function doLogout() {
            try {
                await fetch(`${API_BASE}/admin/logout`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
            } catch (e) { }

            adminToken = '';
            localStorage.removeItem('adminToken');
            document.getElementById('loginOverlay').classList.remove('hidden');
            document.getElementById('loginPassword').value = '';
        }

        // 验证会话
        async function verifySession() {
            if (!adminToken) {
                return false;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/verify`, {
                    headers: { 'X-Admin-Token': adminToken }
                });
                return response.ok;
            } catch (e) {
                return false;
            }
        }

        // 带认证的 fetch 封装
        async function authFetch(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: {
                    ...options.headers,
                    'X-Admin-Token': adminToken
                }
            });

            if (response.status === 401) {
                doLogout();
                throw new Error('会话已过期，请重新登录');
            }

            return response;
        }

        // 切换标签页
        function switchTab(tabName) {
            // 移除所有标签的active类
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));

            // 添加active类到选中的标签内容
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }

            // 找到并激活对应的导航按钮
            const activeButton = document.querySelector(`.nav-tab[onclick*="'${tabName}'"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }

            // 加载对应数据
            if (tabName === 'tokens') loadTokens();
            if (tabName === 'keys') loadKeys();
            if (tabName === 'logs') loadLogs();
            if (tabName === 'home') loadHomeData();
            if (tabName === 'test') loadModels();
            if (tabName === 'settings') loadSettings();
            if (tabName === 'proxies') loadProxies();
            if (tabName === 'pricing') loadPricing();
        }

        // 自动刷新功能
        function toggleAutoRefresh(type) {
            const checkbox = document.getElementById(`autoRefresh${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const intervalId = `${type}Interval`;

            if (checkbox.checked) {
                // 启动自动刷新 (每5秒)
                if (type === 'logs') {
                    autoRefreshIntervals[intervalId] = setInterval(loadLogs, 5000);
                } else if (type === 'monitor') {
                    autoRefreshIntervals[intervalId] = setInterval(loadMonitorData, 5000);
                }
            } else {
                // 停止自动刷新
                if (autoRefreshIntervals[intervalId]) {
                    clearInterval(autoRefreshIntervals[intervalId]);
                    delete autoRefreshIntervals[intervalId];
                }
            }
        }

        // 首页数据
        async function loadHomeData() {
            try {
                const [keys, tokens, keyStats, tokenStats] = await Promise.all([
                    authFetch(`${API_BASE}/admin/keys`).then(r => r.json()),
                    authFetch(`${API_BASE}/admin/tokens`).then(r => r.json()),
                    authFetch(`${API_BASE}/admin/keys/stats`).then(r => r.json()).catch(() => ({ totalRequests: 0 })),
                    authFetch(`${API_BASE}/admin/tokens/stats`).then(r => r.json()).catch(() => ({ enabled: 0, disabled: 0 }))
                ]);

                document.getElementById('keyCount').textContent = keys.length;
                document.getElementById('tokenCount').textContent = tokens.length;

                // 更新详细统计
                document.getElementById('keyRequests').textContent = keyStats.totalRequests || 0;
                document.getElementById('tokenEnabled').textContent = tokenStats.enabled || 0;
                document.getElementById('tokenDisabled').textContent = tokenStats.disabled || 0;

                // 加载监控数据
                loadMonitorData();
            } catch (error) {
                console.error('加载首页数据失败:', error);
            }
        }

        // Token 管理
        async function triggerGoogleLogin() {
            const btn = document.getElementById('loginBtn');
            const resultEl = document.getElementById('loginResult');

            btn.disabled = true;
            btn.textContent = '登录中...';
            resultEl.innerHTML = '<div class="alert alert-info">正在启动登录流程...</div>';

            try {
                const response = await authFetch(`${API_BASE}/admin/tokens/login`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success && data.authUrl) {
                    resultEl.innerHTML = `
            <div class="alert alert-success">
              <p><strong>登录流程已启动！</strong></p>
              <p style="margin: 10px 0;">请在打开的浏览器窗口中完成 Google 授权。</p>
              <a href="${data.authUrl}" target="_blank" class="btn-success" style="display: inline-block; text-decoration: none; margin-top: 10px;">点击这里打开授权页面</a>
            </div>
          `;
                    // 自动打开授权页面
                    window.open(data.authUrl, '_blank');
                    // 10秒后刷新Token列表
                    setTimeout(() => {
                        loadTokens();
                        resultEl.innerHTML = '<div class="alert alert-info">授权完成后，Token 将自动添加到列表中。如未看到，请点击"刷新列表"按钮。</div>';
                    }, 10000);
                } else {
                    resultEl.innerHTML = `<div class="alert alert-error">${data.message || '登录失败'}</div>`;
                }
            } catch (error) {
                resultEl.innerHTML = `<div class="alert alert-error">登录失败: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = '登录获取 Token';
            }
        }

        let selectedTokens = new Set();

        async function loadTokens() {
            try {
                const response = await authFetch(`${API_BASE}/admin/tokens`);
                const tokens = await response.json();
                const container = document.getElementById('tokenList');

                if (tokens.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">暂无 Token 账号</div>';
                    return;
                }

                // 获取账号名称
                const indices = tokens.map(t => t.index);
                let accountNames = {};
                try {
                    const detailsResponse = await authFetch(`${API_BASE}/admin/tokens/details`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ indices })
                    });
                    const details = await detailsResponse.json();
                    details.forEach(d => {
                        accountNames[d.index] = {
                            email: d.email,
                            name: d.name,
                            proxyId: d.proxyId,
                            disabledUntil: d.disabledUntil,
                            quotaExhausted: d.quotaExhausted,
                            dailyCost: d.dailyCost,
                            totalCost: d.totalCost
                        };
                    });
                } catch (e) {
                    console.error('获取账号名称失败:', e);
                }

                // 获取代理列表
                let proxies = [];
                try {
                    const proxiesResponse = await authFetch(`${API_BASE}/admin/proxies`);
                    proxies = await proxiesResponse.json();
                } catch (e) {
                    console.error('获取代理列表失败:', e);
                }

                container.innerHTML = tokens.map(token => {
                    const accountInfo = accountNames[token.index] || { email: 'Unknown', name: 'Unknown', proxyId: null, disabledUntil: null, quotaExhausted: false, dailyCost: 0, totalCost: 0 };
                    const proxyOptions = proxies.map(p =>
                        `<option value="${p.id}" ${accountInfo.proxyId === p.id ? 'selected' : ''}>${p.name} (${p.protocol}://${p.host}:${p.port})</option>`
                    ).join('');

                    // 计算状态显示
                    let statusBadge = '';
                    let disabledInfo = '';
                    if (accountInfo.disabledUntil) {
                        const restoreTime = new Date(accountInfo.disabledUntil);
                        const now = new Date();
                        if (restoreTime > now) {
                            statusBadge = '<span style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">配额耗尽</span>';
                            disabledInfo = `<div style="color: #e74c3c; font-size: 0.9em; margin-top: 5px;">⏰ 将于 ${restoreTime.toLocaleString('zh-CN')} 自动恢复</div>`;
                        } else {
                            statusBadge = token.enable ?
                                '<span style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">已启用</span>' :
                                '<span style="background: #95a5a6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">已禁用</span>';
                        }
                    } else {
                        statusBadge = token.enable ?
                            '<span style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">已启用</span>' :
                            '<span style="background: #95a5a6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">已禁用</span>';
                    }

                    return `
            <div class="token-item" style="padding: 10px 15px;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
                        <input type="checkbox" id="token-${token.index}" onchange="toggleTokenSelection(${token.index})" ${selectedTokens.has(token.index) ? 'checked' : ''} style="width: auto; margin: 0;">
                        <strong style="color: #2c3e50;">${accountInfo.name}</strong>
                        <span style="color: #7f8c8d; font-size: 0.9em;">(${accountInfo.email})</span>
                        ${statusBadge}
                        <span style="background: #3498db; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">今日: $${(accountInfo.dailyCost||0).toFixed(4)}</span>
                        <span style="background: #8e44ad; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">累计: $${(accountInfo.totalCost||0).toFixed(4)}</span>
                    </div>
                    ${disabledInfo}
                </div>
                <div class="flex-buttons" style="margin-top: 0; gap: 5px;">
                   ${accountInfo.disabledUntil && accountInfo.quotaExhausted ?
                            `<button onclick="restoreToken(${token.index})" class="btn-success" style="padding: 4px 10px; font-size: 12px; background: #27ae60;">
                      恢复
                    </button>` : ''
                        }
                  <button onclick="toggleToken(${token.index}, ${!token.enable})" class="btn-warning" style="padding: 4px 10px; font-size: 12px;">
                    ${token.enable ? '禁用' : '启用'}
                  </button>
                  <button onclick="deleteToken(${token.index})" class="btn-danger" style="padding: 4px 10px; font-size: 12px;">删除</button>
                </div>
              </div>
              
              <div style="display: flex; gap: 15px; align-items: center; font-size: 0.9em;">
                 <div style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #666; font-family: monospace; background: #f5f5f5; padding: 4px 8px; border-radius: 4px;">${token.access_token}</div>
                 <div style="display: flex; align-items: center; gap: 5px;">
                    <label style="color: #999; font-size: 0.9em; white-space: nowrap;">代理:</label>
                    <select onchange="setTokenProxy(${token.index}, this.value, this)" style="padding: 3px 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.9em; width: 140px;">
                        <option value="" ${!accountInfo.proxyId ? 'selected' : ''}>无代理</option>
                        ${proxyOptions}
                    </select>
                 </div>
                 <div style="color: #999; font-size: 0.85em; white-space: nowrap;">
                    创建: ${token.created}
                 </div>
              </div>
            </div>
          `;
                }).join('');
            } catch (error) {
                document.getElementById('tokenList').innerHTML =
                    `<div class="alert alert-error">加载 Token 失败: ${error.message}</div>`;
            }
        }

        function toggleTokenSelection(index) {
            const checkbox = document.getElementById(`token-${index}`);
            if (checkbox && checkbox.checked) {
                selectedTokens.add(index);
            } else {
                selectedTokens.delete(index);
            }
        }

        function selectAllTokens() {
            const checkboxes = document.querySelectorAll('[id^="token-"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
                const index = parseInt(cb.id.replace('token-', ''));
                if (cb.checked) {
                    selectedTokens.add(index);
                } else {
                    selectedTokens.delete(index);
                }
            });
        }

        async function exportSelectedTokens() {
            if (selectedTokens.size === 0) {
                alert('请先选择要导出的账号');
                return;
            }

            try {
                const response = await authFetch(`${API_BASE}/admin/tokens/export`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ indices: Array.from(selectedTokens) })
                });

                // 下载为 ZIP 文件
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tokens_export_${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert(`成功导出 ${selectedTokens.size} 个账号`);
            } catch (error) {
                alert('导出失败: ' + error.message);
            }
        }

        // 导入 Token
        async function importTokens() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.zip';

            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch(`${API_BASE}/admin/tokens/import`, {
                        method: 'POST',
                        headers: {
                            'X-Admin-Token': adminToken
                        },
                        body: formData
                    });

                    const result = await response.json();
                    if (response.ok) {
                        alert(result.message || '导入成功！');
                        loadTokens();
                    } else {
                        alert('导入失败: ' + (result.error || '未知错误'));
                    }
                } catch (error) {
                    alert('导入失败: ' + error.message);
                }
            };

            input.click();
        }

        async function toggleToken(index, enable) {
            try {
                await authFetch(`${API_BASE}/admin/tokens/${index}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enable })
                });
                loadTokens();
            } catch (error) {
                alert(`${enable ? '启用' : '禁用'}Token 失败: ` + error.message);
            }
        }

        async function deleteToken(index) {
            if (!confirm('确定要删除这个 Token 账号吗？')) return;
            try {
                await authFetch(`${API_BASE}/admin/tokens/${index}`, {
                    method: 'DELETE'
                });
                loadTokens();
            } catch (error) {
                alert('删除 Token 失败: ' + error.message);
            }
        }

        async function restoreToken(index) {
            if (!confirm('确定要手动恢复此 Token 的配额限制吗？\n\n注意：这会立即解除配额耗尽的禁用状态，但如果继续使用可能会再次遇到配额限制。')) return;
            try {
                const response = await authFetch(`${API_BASE}/admin/tokens/${index}/restore`, {
                    method: 'POST'
                });
                const result = await response.json();
                alert(result.message || 'Token 已恢复');
                loadTokens();
            } catch (error) {
                alert('恢复 Token 失败: ' + error.message);
            }
        }

        // 手动添加 Token
        async function addTokenManually() {
            const callbackUrl = document.getElementById('callbackUrl').value.trim();
            const btn = document.getElementById('addTokenBtn');
            const resultEl = document.getElementById('addTokenResult');

            if (!callbackUrl) {
                resultEl.innerHTML = '<div class="alert alert-error">请输入回调链接</div>';
                return;
            }

            btn.disabled = true;
            btn.textContent = '添加中...';
            resultEl.innerHTML = '<div class="alert alert-info">正在处理回调链接...</div>';

            try {
                const response = await authFetch(`${API_BASE}/admin/tokens/callback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ callbackUrl })
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    resultEl.innerHTML = '<div class="alert alert-success">Token 添加成功！</div>';
                    document.getElementById('callbackUrl').value = '';
                    loadTokens();
                } else {
                    resultEl.innerHTML = `<div class="alert alert-error">${data.error || '添加失败'}</div>`;
                }
            } catch (error) {
                resultEl.innerHTML = `<div class="alert alert-error">添加失败: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = '添加 Token';
            }
        }

        // 切换频率限制字段显示
        function toggleRateLimitFields() {
            const enabled = document.getElementById('enableRateLimit').checked;
            document.getElementById('rateLimitFields').style.display = enabled ? 'block' : 'none';
        }

        // 生成密钥
        async function generateKey() {
            const name = document.getElementById('keyName').value || '未命名';
            const enableRateLimit = document.getElementById('enableRateLimit').checked;

            let rateLimit = null;
            if (enableRateLimit) {
                const maxRequests = parseInt(document.getElementById('maxRequests').value) || 100;
                const windowSeconds = parseInt(document.getElementById('windowSeconds').value) || 60;
                rateLimit = {
                    enabled: true,
                    maxRequests,
                    windowMs: windowSeconds * 1000
                };
            }

            // 获取费用上限
            let maxBalance = parseFloat(document.getElementById('maxBalance').value);
            if (isNaN(maxBalance)) {
                maxBalance = 10; // 默认 10 美元
            }
            // -1 表示无限额度
            if (maxBalance === -1) {
                maxBalance = null;
            }

            try {
                const response = await authFetch(`${API_BASE}/admin/keys/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, rateLimit, maxBalance })
                });
                const data = await response.json();
                if (data.key) {
                    const balanceInfo = data.isUnlimited ? '无限额度' : `$${data.maxBalance}`;
                    alert(`密钥生成成功！\n\n密钥: ${data.key}\n费用上限: ${balanceInfo}\n\n请妥善保存，此密钥不会再次显示！`);
                    document.getElementById('keyName').value = '';
                    document.getElementById('enableRateLimit').checked = false;
                    document.getElementById('maxBalance').value = '10';
                    toggleRateLimitFields();
                    loadKeys();
                }
            } catch (error) {
                alert('生成密钥失败: ' + error.message);
            }
        }

        // 加载密钥列表
        async function loadKeys() {
            try {
                const response = await authFetch(`${API_BASE}/admin/keys`);
                const keys = await response.json();
                const listEl = document.getElementById('keyList');

                if (keys.length === 0) {
                    listEl.innerHTML = '<li style="text-align: center; color: #999;">暂无密钥</li>';
                    return;
                }

                listEl.innerHTML = keys.map(key => {
                    const rateLimitInfo = key.rateLimit && key.rateLimit.enabled
                        ? `<span style="background: #f39c12; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">限制: ${key.rateLimit.maxRequests}次/${key.rateLimit.windowMs / 1000}秒</span>`
                        : '<span style="background: #3498db; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">无限制</span>';

                    // 余额信息
                    const balance = key.balance || 0;
                    const maxBalance = key.maxBalance || 0;
                    const totalSpent = key.totalSpent || 0;
                    const isUnlimited = key.isUnlimited;

                    let balanceColor = '#27ae60'; // 默认绿色
                    if (!isUnlimited) {
                        if (balance <= 0) {
                            balanceColor = '#e74c3c'; // 红色
                        } else if (balance < maxBalance * 0.2) {
                            balanceColor = '#f39c12'; // 橙色
                        }
                    }

                    const balanceInfo = isUnlimited
                        ? `<span style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">无限额度</span>`
                        : `<span style="background: ${balanceColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">余额: $${balance.toFixed(2)} / $${maxBalance.toFixed(2)}</span>`;

                    return `
            <li class="key-item">
              <div style="flex: 1;">
                <div style="margin-bottom: 10px;">
                  <strong style="color: #2c3e50; font-size: 1.1em;">${key.name}</strong>
                  ${key.lastUsed ? `<span style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">已使用</span>` : `<span style="background: #95a5a6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">未使用</span>`}
                  ${rateLimitInfo}
                  ${balanceInfo}
                </div>
                <div class="key-value">${key.key}</div>
                <div style="margin-top: 8px;">
                  <small style="color: #7f8c8d;">创建时间: ${new Date(key.created).toLocaleString()}</small>
                  ${key.lastUsed ? `<small style="color: #7f8c8d; margin-left: 15px;">上次使用: ${new Date(key.lastUsed).toLocaleString()}</small>` : ''}
                  ${key.requests ? `<small style="color: #7f8c8d; margin-left: 15px;">请求次数: ${key.requests}</small>` : ''}
                  ${!isUnlimited ? `<small style="color: #7f8c8d; margin-left: 15px;">总消费: $${totalSpent.toFixed(6)}</small>` : ''}
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn-primary" onclick="editKeyBalance('${key.key}', ${key.maxBalance}, ${key.isUnlimited})" style="background: #3498db;">编辑额度</button>
                <button class="btn-danger" onclick="deleteKey('${key.key}')">删除</button>
              </div>
            </li>
          `;
                }).join('');
            } catch (error) {
                console.error('加载密钥失败:', error);
            }
        }

        // 删除密钥
        async function deleteKey(key) {
            if (!confirm('确定要删除这个密钥吗？')) return;
            try {
                await authFetch(`${API_BASE}/admin/keys/${encodeURIComponent(key)}`, {
                    method: 'DELETE'
                });
                loadKeys();
            } catch (error) {
                alert('删除密钥失败: ' + error.message);
            }
        }

        // 编辑密钥额度
        async function editKeyBalance(key, currentMaxBalance, isUnlimited) {
            const displayBalance = isUnlimited ? '无限' : currentMaxBalance;
            const newBalanceInput = prompt(
                `请输入新的余额上限（美元）：\n当前额度: ${displayBalance}\n\n输入 -1 或 0 设置为无限额度`,
                isUnlimited ? '-1' : currentMaxBalance
            );

            if (newBalanceInput === null) return; // 用户取消

            let newMaxBalance = parseFloat(newBalanceInput);
            if (isNaN(newMaxBalance)) {
                alert('请输入有效的数字！');
                return;
            }

            // -1 或 0 表示无限额度
            if (newMaxBalance <= 0) {
                newMaxBalance = -1;
            }

            try {
                const response = await authFetch(`${API_BASE}/admin/keys/${encodeURIComponent(key)}/balance`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ maxBalance: newMaxBalance })
                });

                const data = await response.json();
                if (data.success) {
                    const balanceText = data.isUnlimited ? '无限额度' : `$${data.maxBalance}`;
                    alert(`额度更新成功！\n新额度: ${balanceText}\n当前余额: $${data.balance.toFixed(2)}`);
                    loadKeys();
                }
            } catch (error) {
                alert('更新额度失败: ' + error.message);
            }
        }

        // 加载模型列表
        async function loadModels() {
            const select = document.getElementById('testModel');
            select.innerHTML = '<option value="">加载中...</option>';

            try {
                // 先尝试从设置中获取默认API密钥
                let apiKey = document.getElementById('testApiKey').value;
                if (!apiKey) {
                    try {
                        const settingsResponse = await authFetch(`${API_BASE}/admin/settings`);
                        const settings = await settingsResponse.json();
                        apiKey = settings.security?.apiKey || 'sk-text';
                    } catch (e) {
                        apiKey = 'sk-text';
                    }
                }

                const response = await fetch(`${API_BASE}/v1/models`, {
                    headers: {
                        'Authorization': 'Bearer ' + apiKey
                    }
                });

                if (!response.ok) {
                    throw new Error('获取模型列表失败');
                }

                const data = await response.json();
                if (data.data && data.data.length > 0) {
                    select.innerHTML = data.data.map(model =>
                        `<option value="${model.id}">${model.id}</option>`
                    ).join('');
                } else {
                    select.innerHTML = '<option value="gpt-4">gpt-4</option><option value="gpt-3.5-turbo">gpt-3.5-turbo</option>';
                }
            } catch (error) {
                console.error('加载模型失败:', error);
                // 回退到默认模型
                select.innerHTML = '<option value="gpt-4">gpt-4</option><option value="gpt-3.5-turbo">gpt-3.5-turbo</option>';
            }
        }

        // 发送测试消息
        async function sendTestMessage() {
            const message = document.getElementById('testMessage').value;
            const model = document.getElementById('testModel').value;
            const apiKey = document.getElementById('testApiKey').value;

            if (!message) {
                alert('请输入消息内容');
                return;
            }

            if (!apiKey) {
                alert('请输入 API 密钥');
                return;
            }

            if (!model) {
                alert('请选择模型');
                return;
            }

            chatHistory.push({ role: 'user', content: message });
            displayMessage('user', message);
            document.getElementById('testMessage').value = '';

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="loading"></span> 发送中...';

            try {
                const response = await fetch(`${API_BASE}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model,
                        messages: chatHistory,
                        stream: true
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let assistantMessage = '';
                const messageEl = displayMessage('assistant', '');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const text = decoder.decode(value);
                    const lines = text.split('\n').filter(line => line.trim().startsWith('data: '));

                    for (const line of lines) {
                        const data = line.replace('data: ', '');
                        if (data === '[DONE]') continue;

                        try {
                            const json = JSON.parse(data);
                            const content = json.choices[0]?.delta?.content || '';
                            assistantMessage += content;
                            messageEl.textContent = assistantMessage;
                        } catch (e) { }
                    }
                }

                chatHistory.push({ role: 'assistant', content: assistantMessage });
            } catch (error) {
                displayMessage('assistant', '错误: ' + error.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = '发送消息';
            }
        }

        function displayMessage(role, content) {
            const container = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${role}`;
            messageEl.textContent = content;
            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
            return messageEl;
        }

        function clearChat() {
            chatHistory = [];
            document.getElementById('chatMessages').innerHTML = '';
        }

        // 加载日志
        async function loadLogs() {
            try {
                const response = await authFetch(`${API_BASE}/admin/logs`);
                const logs = await response.json();
                const container = document.getElementById('logContainer');

                if (logs.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">暂无日志</div>';
                    return;
                }

                container.innerHTML = logs.map(log => {
                    let logClass = 'log-info';
                    if (log.level === 'warn') logClass = 'log-warn';
                    if (log.level === 'error') logClass = 'log-error';
                    if (log.level === 'success') logClass = 'log-success';

                    return `<div class="log-entry ${logClass}">${log.timestamp} [${log.level.toUpperCase()}] ${log.message}</div>`;
                }).join('');
            } catch (error) {
                document.getElementById('logContainer').innerHTML =
                    `<div class="alert alert-error">加载日志失败: ${error.message}</div>`;
            }
        }

        // 清空日志
        async function clearLogs() {
            if (!confirm('确定要清空所有日志吗？')) return;
            try {
                await authFetch(`${API_BASE}/admin/logs`, { method: 'DELETE' });
                loadLogs();
            } catch (error) {
                alert('清空日志失败: ' + error.message);
            }
        }

        // 加载监控数据
        async function loadMonitorData() {
            try {
                const statusResponse = await authFetch(`${API_BASE}/admin/status`);
                const data = await statusResponse.json();

                // 尝试获取 Token 使用统计（可能需要重启服务器才可用）
                let usageData = { totalTokens: 0, currentIndex: 0, totalRequests: 0, tokens: [] };
                try {
                    const usageResponse = await authFetch(`${API_BASE}/admin/tokens/usage`);
                    usageData = await usageResponse.json();
                } catch (e) {
                    console.log('Token 使用统计暂不可用（需要重启服务器）');
                }

                document.getElementById('cpuUsage').textContent = data.cpu + '%';
                document.getElementById('memoryUsage').textContent = data.memory;
                document.getElementById('uptime').textContent = data.uptime;
                document.getElementById('totalRequests').textContent = data.requests;

                // 显示空闲状态
                const idleStatusEl = document.getElementById('idleStatus');
                idleStatusEl.textContent = data.idle || '活跃';
                idleStatusEl.style.color = data.idle === '空闲模式' ? '#f39c12' : '#27ae60';
                document.getElementById('idleTime').textContent = data.idleTime || 0;

                // 显示 Token 使用统计
                const usageContainer = document.getElementById('tokenUsageStats');
                if (usageData.totalTokens === 0 || !usageData.tokens || usageData.tokens.length === 0) {
                    usageContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">暂无 Token 账号</div>';
                } else {
                    usageContainer.innerHTML = `
            <div style="margin-bottom: 15px;">
              <span style="background: #667eea; color: white; padding: 5px 12px; border-radius: 4px; margin-right: 10px;">
                总 Token 数: ${usageData.totalTokens}
              </span>
              <span style="background: #27ae60; color: white; padding: 5px 12px; border-radius: 4px; margin-right: 10px;">
                当前轮询位置: #${usageData.currentIndex}
              </span>
              <span style="background: #3498db; color: white; padding: 5px 12px; border-radius: 4px;">
                总请求数: ${usageData.totalRequests}
              </span>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
              ${(usageData.tokens || []).map(token => `
                <div style="padding: 15px; background: ${token.isCurrent ? '#e8f4fd' : '#f8f9fa'}; border-radius: 8px; border-left: 3px solid ${token.isCurrent ? '#3498db' : '#95a5a6'};">
                  <div style="color: #2c3e50; font-weight: 600; margin-bottom: 8px;">
                    Token #${token.index}
                    ${token.isCurrent ? '<span style="background: #3498db; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; margin-left: 5px;">当前</span>' : ''}
                  </div>
                  <div style="color: #7f8c8d; font-size: 0.9em;">
                    <div>请求次数: <strong style="color: #667eea;">${token.requests}</strong></div>
                    <div>最后使用: ${token.lastUsed ? new Date(token.lastUsed).toLocaleString() : '从未使用'}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
                }

                document.getElementById('systemInfo').innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #667eea;">
              <div style="color: #7f8c8d; font-size: 0.9em; margin-bottom: 5px;">Node 版本</div>
              <div style="color: #2c3e50; font-weight: 600; font-size: 1.1em;">${data.nodeVersion}</div>
            </div>
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #3498db;">
              <div style="color: #7f8c8d; font-size: 0.9em; margin-bottom: 5px;">平台</div>
              <div style="color: #2c3e50; font-weight: 600; font-size: 1.1em;">${data.platform}</div>
            </div>
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #27ae60;">
              <div style="color: #7f8c8d; font-size: 0.9em; margin-bottom: 5px;">进程 PID</div>
              <div style="color: #2c3e50; font-weight: 600; font-size: 1.1em;">${data.pid}</div>
            </div>
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #f39c12;">
              <div style="color: #7f8c8d; font-size: 0.9em; margin-bottom: 5px;">系统内存</div>
              <div style="color: #2c3e50; font-weight: 600; font-size: 1.1em;">${data.systemMemory}</div>
            </div>
          </div>
        `;
            } catch (error) {
                document.getElementById('systemInfo').innerHTML =
                    `<div class="alert alert-error">加载监控数据失败: ${error.message}</div>`;
            }
        }

        // 加载系统设置
        async function loadSettings() {
            try {
                const response = await authFetch(`${API_BASE}/admin/settings`);
                const settings = await response.json();

                // 填充表单
                document.getElementById('settingPort').value = settings.server?.port || '';
                document.getElementById('settingHost').value = settings.server?.host || '';
                document.getElementById('settingApiKey').value = settings.security?.apiKey || '';
                document.getElementById('settingAdminPassword').value = settings.security?.adminPassword || '';
                document.getElementById('settingMaxRequestSize').value = settings.security?.maxRequestSize || '';
                document.getElementById('settingTemperature').value = settings.defaults?.temperature || '';
                document.getElementById('settingTopP').value = settings.defaults?.top_p || '';
                document.getElementById('settingTopK').value = settings.defaults?.top_k || '';
                document.getElementById('settingMaxTokens').value = settings.defaults?.max_tokens || '';
                document.getElementById('settingSystemInstruction').value = settings.systemInstruction || '';
            } catch (error) {
                alert('加载设置失败: ' + error.message);
            }
        }

        // 保存系统设置
        async function saveSettings() {
            try {
                const settings = {
                    server: {
                        port: parseInt(document.getElementById('settingPort').value) || 8045,
                        host: document.getElementById('settingHost').value || '0.0.0.0'
                    },
                    security: {
                        apiKey: document.getElementById('settingApiKey').value || 'sk-text',
                        adminPassword: document.getElementById('settingAdminPassword').value || 'admin123',
                        maxRequestSize: document.getElementById('settingMaxRequestSize').value || '50mb'
                    },
                    defaults: {
                        temperature: parseFloat(document.getElementById('settingTemperature').value) || 1,
                        top_p: parseFloat(document.getElementById('settingTopP').value) || 0.85,
                        top_k: parseInt(document.getElementById('settingTopK').value) || 50,
                        max_tokens: parseInt(document.getElementById('settingMaxTokens').value) || 8096
                    },
                    systemInstruction: document.getElementById('settingSystemInstruction').value || ''
                };

                const response = await authFetch(`${API_BASE}/admin/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message || '设置已保存！请重启服务器以应用更改。');
                } else {
                    alert('保存失败: ' + (result.error || '未知错误'));
                }
            } catch (error) {
                alert('保存设置失败: ' + error.message);
            }
        }

        // ===== 代理管理函数 =====

        // 加载代理列表
        async function loadProxies() {
            try {
                const response = await authFetch(`${API_BASE}/admin/proxies`);
                const proxies = await response.json();
                const container = document.getElementById('proxyList');

                if (proxies.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">暂无代理配置</div>';
                    return;
                }

                container.innerHTML = proxies.map(proxy => `
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: ${proxy.enabled ? '#111827' : '#9ca3af'};">
                                    ${proxy.name}
                                    <span style="background: ${proxy.enabled ? '#10b981' : '#6b7280'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px;">
                                        ${proxy.enabled ? '已启用' : '已禁用'}
                                    </span>
                                    ${proxy.testStatus ? `
                                        <span style="background: ${proxy.testStatus === 'success' ? '#10b981' : '#ef4444'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px;">
                                            ${proxy.testStatus === 'success' ? '✓ 正常' : '✗ 失败'}
                                        </span>
                                    ` : ''}
                                </div>
                                <div style="color: #6b7280; font-size: 14px;">
                                    ${proxy.protocol}://${proxy.host}:${proxy.port}
                                    ${proxy.username ? ` (用户: ${proxy.username})` : ''}
                                </div>
                                ${proxy.lastTested ? `
                                    <div style="color: #9ca3af; font-size: 12px; margin-top: 4px;">
                                        最后测试: ${new Date(proxy.lastTested).toLocaleString()}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="testProxy('${proxy.id}')" class="btn-secondary" style="padding: 6px 12px; font-size: 14px;">
                                    测试连接
                                </button>
                                <button onclick="toggleProxy('${proxy.id}', ${!proxy.enabled})" class="btn-${proxy.enabled ? 'secondary' : 'success'}" style="padding: 6px 12px; font-size: 14px;">
                                    ${proxy.enabled ? '禁用' : '启用'}
                                </button>
                                <button onclick="deleteProxy('${proxy.id}')" class="btn-danger" style="padding: 6px 12px; font-size: 14px;">
                                    删除
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('加载代理列表失败:', error);
                document.getElementById('proxyList').innerHTML =
                    '<div style="text-align: center; color: #ef4444; padding: 20px;">加载失败</div>';
            }
        }

        // 解析代理URL并填充表单
        function parseProxyUrl() {
            const quickInput = document.getElementById('proxyQuickInput').value.trim();
            if (!quickInput) {
                alert('请输入代理URL！');
                return;
            }

            try {
                // 支持的格式：protocol://[username:password@]host:port
                // 例如：socks5://user:pass@127.0.0.1:1080 或 socks5://127.0.0.1:1080
                const urlPattern = /^(socks5|socks4|http|https):\/\/(?:([^:]+):([^@]+)@)?([^:]+):(\d+)$/;
                const match = quickInput.match(urlPattern);

                if (!match) {
                    alert('代理URL格式不正确！\n正确格式：protocol://[username:password@]host:port\n例如：socks5://user:pass@127.0.0.1:1080');
                    return;
                }

                const [, protocol, username, password, host, port] = match;

                // 填充表单
                document.getElementById('proxyProtocol').value = protocol;
                document.getElementById('proxyHost').value = host;
                document.getElementById('proxyPort').value = port;
                document.getElementById('proxyUsername').value = username || '';
                document.getElementById('proxyPassword').value = password || '';

                // 自动生成代理名称（如果没有填写）
                if (!document.getElementById('proxyName').value) {
                    const nameParts = [protocol.toUpperCase(), host];
                    if (username) nameParts.push(username);
                    document.getElementById('proxyName').value = nameParts.join('_');
                }

                alert('代理信息已自动填充！请检查并添加。');
            } catch (error) {
                alert('解析代理URL失败: ' + error.message);
            }
        }

        // 添加代理
        async function addProxy() {
            try {
                const name = document.getElementById('proxyName').value;
                const protocol = document.getElementById('proxyProtocol').value;
                const host = document.getElementById('proxyHost').value;
                const port = document.getElementById('proxyPort').value;
                const username = document.getElementById('proxyUsername').value;
                const password = document.getElementById('proxyPassword').value;

                if (!name || !host || !port) {
                    alert('请填写代理名称、主机地址和端口！');
                    return;
                }

                const response = await authFetch(`${API_BASE}/admin/proxies`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        protocol,
                        host,
                        port: parseInt(port),
                        username: username || null,
                        password: password || null,
                        enabled: true
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    alert('代理已成功添加！');
                    // 清空表单
                    document.getElementById('proxyQuickInput').value = '';
                    document.getElementById('proxyName').value = '';
                    document.getElementById('proxyHost').value = '';
                    document.getElementById('proxyPort').value = '';
                    document.getElementById('proxyUsername').value = '';
                    document.getElementById('proxyPassword').value = '';
                    await loadProxies();
                } else {
                    alert('添加代理失败: ' + (result.error || '未知错误'));
                }
            } catch (error) {
                alert('添加代理失败: ' + error.message);
            }
        }

        // 测试单个代理
        async function testProxy(proxyId) {
            try {
                const button = event.target;
                button.disabled = true;
                button.textContent = '测试中...';

                const response = await authFetch(`${API_BASE}/admin/proxies/${proxyId}/test`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    alert(`代理测试成功！\n延迟: ${result.latency}ms\n状态: ${result.status}`);
                } else {
                    alert(`代理测试失败！\n错误: ${result.message}`);
                }

                await loadProxies();
            } catch (error) {
                alert('测试代理失败: ' + error.message);
            } finally {
                event.target.disabled = false;
                event.target.textContent = '测试连接';
            }
        }

        // 测试所有代理
        async function testAllProxies() {
            try {
                const button = event.target;
                button.disabled = true;
                button.textContent = '测试中...';

                const response = await authFetch(`${API_BASE}/admin/proxies/test-all`, {
                    method: 'POST'
                });

                const results = await response.json();

                const successCount = results.filter(r => r.success).length;
                alert(`批量测试完成！\n成功: ${successCount}/${results.length}`);

                await loadProxies();
            } catch (error) {
                alert('测试代理失败: ' + error.message);
            } finally {
                event.target.disabled = false;
                event.target.textContent = '测试所有代理';
            }
        }

        // 切换代理启用状态
        async function toggleProxy(proxyId, enabled) {
            try {
                const response = await authFetch(`${API_BASE}/admin/proxies/${proxyId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });

                const result = await response.json();
                if (response.ok) {
                    await loadProxies();
                } else {
                    alert('操作失败: ' + (result.error || '未知错误'));
                }
            } catch (error) {
                alert('操作失败: ' + error.message);
            }
        }

        // 删除代理
        async function deleteProxy(proxyId) {
            if (!confirm('确定要删除这个代理吗？')) {
                return;
            }

            try {
                const response = await authFetch(`${API_BASE}/admin/proxies/${proxyId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (response.ok) {
                    alert('代理已删除');
                    await loadProxies();
                } else {
                    alert('删除失败: ' + (result.error || '未知错误'));
                }
            } catch (error) {
                alert('删除失败: ' + error.message);
            }
        }

        // 为Token设置代理
        async function setTokenProxy(tokenIndex, proxyId, selectElement) {
            try {
                const response = await authFetch(`${API_BASE}/admin/tokens/${tokenIndex}/proxy`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ proxyId: proxyId || null })
                });

                const result = await response.json();
                if (response.ok) {
                    // 显示临时成功提示
                    if (selectElement) {
                        const originalBg = selectElement.style.background;
                        selectElement.style.background = '#d1fae5';
                        selectElement.style.transition = 'background 0.3s';

                        setTimeout(() => {
                            selectElement.style.background = originalBg;
                        }, 1000);
                    }

                    console.log(`✓ Token ${tokenIndex} 的代理已${proxyId ? '设置' : '移除'}`);
                } else {
                    alert('设置代理失败: ' + (result.error || '未知错误'));
                }
            } catch (error) {
                alert('设置代理失败: ' + error.message);
            }
        }


        // ========== 定价管理相关函数 ==========

        // 加载定价列表
        async function loadPricing() {
            try {
                const response = await authFetch(`${API_BASE}/admin/pricing`);
                const pricing = await response.json();
                const listEl = document.getElementById('pricingList');

                if (Object.keys(pricing).length === 0) {
                    listEl.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 20px;">暂无定价配置</div>';
                    return;
                }

                const pricingHtml = Object.entries(pricing).map(([model, prices]) => {
                    const isDefault = model === 'default';
                    const canDelete = !isDefault;

                    return `
                        <div style="padding: 15px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="margin-bottom: 8px;">
                                    <strong style="color: #2c3e50; font-size: 1.1em;">${model}</strong>
                                    ${isDefault ? '<span style="background: #3498db; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">默认</span>' : ''}
                                </div>
                                <div style="color: #6b7280;">
                                    <span>输入: $${prices.input.toFixed(6)}/M tokens</span>
                                    <span style="margin-left: 20px;">输出: $${prices.output.toFixed(6)}/M tokens</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-primary" onclick="editPricing('${model}', ${prices.input}, ${prices.output})" style="background: #3498db;">编辑</button>
                                ${canDelete ? `<button class="btn-danger" onclick="deletePricing('${model}')">删除</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                listEl.innerHTML = pricingHtml;
            } catch (error) {
                console.error('加载定价失败:', error);
                alert('加载定价失败: ' + error.message);
            }
        }

        // 编辑定价
        async function editPricing(model, currentInputPrice, currentOutputPrice) {
            const newInputPrice = prompt(
                `编辑模型 ${model} 的输入token价格（美元/百万tokens）：\n当前价格: $${currentInputPrice}/M`,
                currentInputPrice
            );

            if (newInputPrice === null) return;

            const inputPrice = parseFloat(newInputPrice);
            if (isNaN(inputPrice) || inputPrice < 0) {
                alert('请输入有效的价格（非负数）！');
                return;
            }

            const newOutputPrice = prompt(
                `编辑模型 ${model} 的输出token价格（美元/百万tokens）：\n当前价格: $${currentOutputPrice}/M`,
                currentOutputPrice
            );

            if (newOutputPrice === null) return;

            const outputPrice = parseFloat(newOutputPrice);
            if (isNaN(outputPrice) || outputPrice < 0) {
                alert('请输入有效的价格（非负数）！');
                return;
            }

            try {
                const response = await authFetch(`${API_BASE}/admin/pricing/${encodeURIComponent(model)}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input: inputPrice, output: outputPrice })
                });

                const data = await response.json();
                if (data.success) {
                    alert(`定价更新成功！\n模型: ${model}\n输入: $${inputPrice}/M\n输出: $${outputPrice}/M`);
                    loadPricing();
                } else {
                    alert('更新失败: ' + (data.error || '未知错误'));
                }
            } catch (error) {
                alert('更新定价失败: ' + error.message);
            }
        }

        // 显示添加定价模态框
        async function showAddPricingModal() {
            const model = prompt('请输入新模型名称（例如：gemini-4-pro）：');
            if (!model || model.trim() === '') return;

            const inputPrice = prompt(`请输入 ${model} 的输入token价格（美元/百万tokens）：`, '1.25');
            if (inputPrice === null) return;

            const inputPriceNum = parseFloat(inputPrice);
            if (isNaN(inputPriceNum) || inputPriceNum < 0) {
                alert('请输入有效的价格（非负数）！');
                return;
            }

            const outputPrice = prompt(`请输入 ${model} 的输出token价格（美元/百万tokens）：`, '5.0');
            if (outputPrice === null) return;

            const outputPriceNum = parseFloat(outputPrice);
            if (isNaN(outputPriceNum) || outputPriceNum < 0) {
                alert('请输入有效的价格（非负数）！');
                return;
            }

            try {
                const response = await authFetch(`${API_BASE}/admin/pricing`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: model.trim(), input: inputPriceNum, output: outputPriceNum })
                });

                const data = await response.json();
                if (data.success) {
                    alert(`新模型定价添加成功！\n模型: ${model}\n输入: $${inputPriceNum}/M\n输出: $${outputPriceNum}/M`);
                    loadPricing();
                } else {
                    alert('添加失败: ' + (data.error || '未知错误'));
                }
            } catch (error) {
                alert('添加定价失败: ' + error.message);
            }
        }

        // 删除定价
        async function deletePricing(model) {
            if (!confirm(`确定要删除模型 ${model} 的定价吗？\n删除后将使用默认定价。`)) {
                return;
            }

            try {
                const response = await authFetch(`${API_BASE}/admin/pricing/${encodeURIComponent(model)}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    alert(`模型 ${model} 的定价已删除！`);
                    loadPricing();
                } else {
                    alert('删除失败: ' + (data.error || '未知错误'));
                }
            } catch (error) {
                alert('删除定价失败: ' + error.message);
            }
        }

        // 重置所有定价为默认值
        async function resetPricing() {
            if (!confirm('确定要重置所有定价为默认值吗？\n此操作将清除所有自定义定价配置！')) {
                return;
            }

            try {
                const response = await authFetch(`${API_BASE}/admin/pricing/reset`, {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.success) {
                    alert('所有定价已重置为默认值！');
                    loadPricing();
                } else {
                    alert('重置失败: ' + (data.error || '未知错误'));
                }
            } catch (error) {
                alert('重置定价失败: ' + error.message);
            }
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('baseUrl').textContent = API_BASE;

            // 检查是否已登录
            const isLoggedIn = await verifySession();
            if (isLoggedIn) {
                document.getElementById('loginOverlay').classList.add('hidden');
                loadHomeData();

                // 加载默认API密钥到测试字段
                try {
                    const settingsResponse = await authFetch(`${API_BASE}/admin/settings`);
                    const settings = await settingsResponse.json();
                    if (settings.security?.apiKey) {
                        document.getElementById('testApiKey').value = settings.security.apiKey;
                    }
                } catch (e) {
                    console.error('加载默认API密钥失败:', e);
                }

                loadModels();
            } else {
                document.getElementById('loginOverlay').classList.remove('hidden');
            }
        });

    </script>
</body>

</html>