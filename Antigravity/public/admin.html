<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antigravity API ç®¡ç†æ§åˆ¶å°</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- Login Overlay -->
    <div id="loginOverlay" class="login-overlay">
        <!-- åˆå§‹åŒ–ç•Œé¢ -->
        <div id="initBox" class="login-box" style="display: none;">
            <h2 style="margin-bottom: 8px; font-size: 24px; font-weight: 700;">ğŸ‰ æ¬¢è¿ä½¿ç”¨</h2>
            <p style="color: #6b7280; margin-bottom: 24px;">é¦–æ¬¡ä½¿ç”¨ï¼Œè¯·è®¾ç½®ç®¡ç†å‘˜è´¦å·</p>
            <div class="form-group">
                <label style="display: block; margin-bottom: 6px; font-weight: 500;">ç”¨æˆ·å</label>
                <input type="text" id="initUsername" placeholder="3-20ä¸ªå­—ç¬¦ï¼Œå­—æ¯æ•°å­—ä¸‹åˆ’çº¿"
                    onkeypress="if(event.key==='Enter')document.getElementById('initPassword').focus()">
            </div>
            <div class="form-group">
                <label style="display: block; margin-bottom: 6px; font-weight: 500;">å¯†ç </label>
                <input type="password" id="initPassword" placeholder="è‡³å°‘8ä¸ªå­—ç¬¦"
                    onkeypress="if(event.key==='Enter')document.getElementById('initPasswordConfirm').focus()">
            </div>
            <div class="form-group">
                <label style="display: block; margin-bottom: 6px; font-weight: 500;">ç¡®è®¤å¯†ç </label>
                <input type="password" id="initPasswordConfirm" placeholder="å†æ¬¡è¾“å…¥å¯†ç "
                    onkeypress="if(event.key==='Enter')doInitialize()">
            </div>
            <button onclick="doInitialize()" id="initBtn" style="width: 100%;">åˆ›å»ºç®¡ç†å‘˜è´¦å·</button>
            <div id="initError" class="login-error" style="color: #ef4444; margin-top: 12px; font-size: 14px;"></div>
            <div id="initSuccess" style="color: #10b981; margin-top: 12px; font-size: 14px; display: none;">
                âœ“ åˆå§‹åŒ–æˆåŠŸï¼æ­£åœ¨è·³è½¬...
            </div>
        </div>

        <!-- ç™»å½•ç•Œé¢ -->
        <div id="loginBox" class="login-box">
            <h2 style="margin-bottom: 8px; font-size: 24px; font-weight: 700;">ç®¡ç†æ§åˆ¶å°</h2>
            <p style="color: #6b7280; margin-bottom: 24px;">è¯·ç™»å½•ä»¥ç»§ç»­</p>
            <div class="form-group">
                <label style="display: block; margin-bottom: 6px; font-weight: 500;">ç”¨æˆ·å</label>
                <input type="text" id="loginUsername" placeholder="ç®¡ç†å‘˜ç”¨æˆ·å"
                    onkeypress="if(event.key==='Enter')document.getElementById('loginPassword').focus()">
            </div>
            <div class="form-group">
                <label style="display: block; margin-bottom: 6px; font-weight: 500;">å¯†ç </label>
                <input type="password" id="loginPassword" placeholder="å¯†ç "
                    onkeypress="if(event.key==='Enter')doLogin()">
            </div>
            <button onclick="doLogin()" id="loginBtn2" style="width: 100%;">ç™»å½•</button>
            <div id="loginError" class="login-error" style="color: #ef4444; margin-top: 12px; font-size: 14px;"></div>
        </div>
    </div>

    <div class="container">
        <div class="header header-gradient">
            <div>
                <h1>ç»Ÿä¸€çš„å¤§è¯­è¨€æ¨¡å‹æ¥å£</h1>
                <p>æ›´å¥½çš„ä»·æ ¼ï¼Œæ›´é«˜çš„å¯ç”¨æ€§ï¼Œæ— éœ€è®¢é˜…ã€‚</p>
            </div>
            <div class="header-actions">
                <button onclick="doLogout()" class="btn btn-secondary"
                    style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('home')">é¦–é¡µ</button>
            <button class="nav-tab" onclick="switchTab('tokens')">ä»¤ç‰Œç®¡ç†</button>
            <button class="nav-tab" onclick="switchTab('keys')">APIå¯†é’¥</button>
            <button class="nav-tab" onclick="switchTab('test')">æµ‹è¯•é¢æ¿</button>
            <button class="nav-tab" onclick="switchTab('logs')">æ—¥å¿—</button>
            <button class="nav-tab" onclick="switchTab('settings')">è®¾ç½®</button>
            <button class="nav-tab" onclick="switchTab('proxies')">ä»£ç†ç®¡ç†</button>
            <button class="nav-tab" onclick="switchTab('pricing')">å®šä»·ç®¡ç†</button>
        </div>

        <!-- Home -->
        <div id="home" class="tab-content active">
            <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                <label class="auto-refresh">
                    <input type="checkbox" id="autoRefreshMonitor" onchange="toggleAutoRefresh('monitor')">
                    <span>è‡ªåŠ¨åˆ·æ–°ç›‘æ§</span>
                </label>
            </div>

            <div class="status-grid">
                <div class="status-card">
                    <h3>æœåŠ¡çŠ¶æ€</h3>
                    <div class="value" id="serviceStatus" style="color: #10b981;">è¿è¡Œä¸­</div>
                </div>
                <div class="status-card">
                    <h3>æ´»è·ƒä»¤ç‰Œ</h3>
                    <div class="value" id="tokenCount">0</div>
                    <small style="color: #6b7280; display: block; margin-top: 4px;">å·²å¯ç”¨: <span
                            id="tokenEnabled">0</span> / å·²ç¦ç”¨: <span id="tokenDisabled">0</span></small>
                </div>
                <div class="status-card">
                    <h3>APIå¯†é’¥</h3>
                    <div class="value" id="keyCount">0</div>
                    <small style="color: #6b7280; display: block; margin-top: 4px;">æ€»è¯·æ±‚æ•°: <span
                            id="keyRequests">0</span></small>
                </div>
                <div class="status-card">
                    <h3>ä»Šæ—¥è¯·æ±‚</h3>
                    <div class="value" id="todayRequests">0</div>
                </div>
                <div class="status-card">
                    <h3>CPU ä½¿ç”¨ç‡</h3>
                    <div class="value" id="cpuUsage">-</div>
                </div>
                <div class="status-card">
                    <h3>å†…å­˜</h3>
                    <div class="value" id="memoryUsage">-</div>
                </div>
                <div class="status-card">
                    <h3>è¿è¡Œæ—¶é—´</h3>
                    <div class="value" id="uptime">-</div>
                </div>
                <div class="status-card">
                    <h3>æ€»è¯·æ±‚æ•°</h3>
                    <div class="value" id="totalRequests">-</div>
                </div>
                <div class="status-card">
                    <h3>æœåŠ¡å™¨çŠ¶æ€</h3>
                    <div class="value" id="idleStatus" style="font-size: 24px;">-</div>
                    <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 5px;">ç©ºé—²æ—¶é—´: <span
                            id="idleTime">0</span>ç§’</small>
                </div>
            </div>

            <div class="card">
                <h3>å¿«é€Ÿå¼€å§‹</h3>
                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <strong style="color: #4b5563;">API Base URL:</strong>
                    <code id="baseUrl" style="background: #fff; padding: 2px 6px; border-radius: 4px; margin-left: 8px; font-family: 'JetBrains Mono', monospace; color: #2563eb;">-</code>
                </div>
                <ol style="margin-left: 20px; color: #4b5563; line-height: 2;">
                    <li>å‰å¾€<strong>ä»¤ç‰Œç®¡ç†</strong>é¡µé¢ï¼Œä½¿ç”¨ Google ç™»å½•ã€‚</li>
                    <li>å‰å¾€<strong>APIå¯†é’¥</strong>é¡µé¢ï¼Œç”Ÿæˆå¯†é’¥ã€‚</li>
                    <li>ä½¿ç”¨<strong>æµ‹è¯•é¢æ¿</strong>æµ‹è¯• APIã€‚</li>
                </ol>
            </div>




            <div class="card">
                <h3>ç³»ç»Ÿä¿¡æ¯</h3>
                <div id="systemInfo">åŠ è½½ä¸­...</div>
            </div>

            <button onclick="loadMonitorData()" class="btn-secondary">åˆ·æ–°ç›‘æ§æ•°æ®</button>
        </div>

        <!-- Tokens -->
        <div id="tokens" class="tab-content">
            <div class="card">
                <h3>æ·»åŠ ä»¤ç‰Œ</h3>
                <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 300px; padding-right: 20px; border-right: 1px solid #eee;">
                        <h4>æ–¹æ³• 1: Google OAuth ç™»å½• (æ¨è)</h4>
                        <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9em;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹ Google OAuth ç™»å½•æµç¨‹ã€‚</p>
                        <button onclick="triggerGoogleLogin()" id="loginBtn" class="btn-success" style="width: 100%;">ä½¿ç”¨ Google ç™»å½•</button>
                        <div id="loginResult" style="margin-top: 15px;"></div>
                    </div>

                    <div style="flex: 1; min-width: 300px;">
                        <h4>æ–¹æ³• 2: æ‰‹åŠ¨æ·»åŠ  (å›è°ƒ URL)</h4>
                        <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9em;">å¦‚æœè‡ªåŠ¨å›è°ƒå¤±è´¥ï¼Œè¯·åœ¨æ­¤å¤„ç²˜è´´å®Œæ•´çš„å›è°ƒ URLã€‚</p>
                        <div class="form-group">
                            <input type="text" id="callbackUrl" placeholder="http://localhost:xxxx/oauth-callback?code=..." style="width: 100%;">
                        </div>
                        <button onclick="addTokenManually()" id="addTokenBtn" class="btn-secondary" style="width: 100%;">æ·»åŠ ä»¤ç‰Œ</button>
                        <div id="addTokenResult" style="margin-top: 15px;"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">æ´»è·ƒä»¤ç‰Œ</h3>
                    <div class="flex-buttons">
                        <button onclick="selectAllTokens()" class="btn-secondary">å…¨é€‰</button>
                        <button onclick="exportSelectedTokens()" class="btn-warning">å¯¼å‡ºæ‰€é€‰</button>
                        <button onclick="importTokens()" class="btn-success">å¯¼å…¥ ZIP</button>
                        <button onclick="loadTokens()" class="btn-secondary">åˆ·æ–°</button>
                    </div>
                </div>
                <div id="tokenList">
                    <div style="text-align: center; color: #9ca3af; padding: 20px;">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- Keys -->
        <div id="keys" class="tab-content">
            <div class="card">
                <h3>ç”Ÿæˆæ–°å¯†é’¥</h3>
                <div class="form-group">
                    <label>å¯†é’¥åç§°ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="keyName" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„åº”ç”¨å¯†é’¥">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="enableRateLimit" onchange="toggleRateLimitFields()"
                            style="width: auto;">
                        å¯ç”¨é€Ÿç‡é™åˆ¶
                    </label>
                </div>
                <div id="rateLimitFields" style="display: none;">
                    <div class="form-group">
                        <label>æœ€å¤§è¯·æ±‚æ•°</label>
                        <input type="number" id="maxRequests" value="100" min="1" placeholder="100">
                    </div>
                    <div class="form-group">
                        <label>æ—¶é—´çª—å£ï¼ˆç§’ï¼‰</label>
                        <input type="number" id="windowSeconds" value="60" min="1" placeholder="60">
                    </div>
                </div>
                <div class="form-group">
                    <label>è´¹ç”¨ä¸Šé™ï¼ˆç¾å…ƒï¼‰</label>
                    <input type="number" id="maxBalance" value="10" min="0" step="0.01" placeholder="10">
                    <small style="color: #6b7280; display: block; margin-top: 4px;">è¾“å…¥ -1 è®¾ç½®ä¸ºæ— é™é¢åº¦</small>
                </div>
                <button onclick="generateKey()">ç”Ÿæˆå¯†é’¥</button>
            </div>

            <div class="card">
                <h3>ç°æœ‰å¯†é’¥</h3>
                <ul class="key-list" id="keyList">
                    <li style="text-align: center; color: #9ca3af;">æœªæ‰¾åˆ°å¯†é’¥</li>
                </ul>
            </div>
        </div>

        <!-- Test -->
        <div id="test" class="tab-content">
            <div class="card">
                <h3>æµ‹è¯•é¢æ¿</h3>
                <div id="chatMessages"></div>
                <div class="form-group">
                    <label>æ¶ˆæ¯</label>
                    <textarea id="testMessage" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯...">ä½ å¥½ï¼Œä½ æ˜¯è°ï¼Ÿ</textarea>
                </div>
                <div class="form-group">
                    <label>æ¨¡å‹ <button onclick="loadModels()" class="btn-secondary"
                            style="padding: 4px 12px; font-size: 12px; margin-left: 10px;">åˆ·æ–°</button></label>
                    <select id="testModel">
                        <option value="">åŠ è½½ä¸­...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>API å¯†é’¥</label>
                    <input type="text" id="testApiKey" placeholder="è¯·è¾“å…¥æ‚¨çš„ API å¯†é’¥">
                </div>
                <div class="flex-buttons">
                    <button onclick="sendTestMessage()" id="sendBtn">å‘é€æ¶ˆæ¯</button>
                    <button onclick="clearChat()" class="btn-secondary">æ¸…ç©ºå¯¹è¯</button>
                </div>
            </div>
        </div>


        <!-- Logs -->
        <div id="logs" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">å®æ—¶æ—¥å¿—</h3>
                    <label class="auto-refresh">
                        <input type="checkbox" id="autoRefreshLogs" onchange="toggleAutoRefresh('logs')">
                        <span>è‡ªåŠ¨åˆ·æ–°</span>
                    </label>
                </div>
                <div class="flex-buttons">
                    <button onclick="loadLogs()" class="btn-secondary">åˆ·æ–°</button>
                    <button onclick="clearLogs()" class="btn-danger">æ¸…ç©ºæ—¥å¿—</button>
                </div>
            </div>
            <div id="logContainer">
                <div style="text-align: center; color: #9ca3af; padding: 20px;">åŠ è½½ä¸­...</div>
            </div>
        </div>



        <!-- Settings -->
        <div id="settings" class="tab-content">
            <div class="card">
                <h3>æœåŠ¡å™¨é…ç½®</h3>
                <div class="form-group">
                    <label>ç«¯å£</label>
                    <input type="number" id="settingPort" placeholder="8045">
                </div>
                <div class="form-group">
                    <label>ä¸»æœº</label>
                    <input type="text" id="settingHost" placeholder="0.0.0.0">
                </div>
            </div>

            <div class="card">
                <h3>å®‰å…¨è®¾ç½®</h3>
                <div class="form-group">
                    <label>é»˜è®¤ API å¯†é’¥</label>
                    <input type="text" id="settingApiKey" placeholder="sk-text">
                </div>
                <div class="form-group">
                    <label>ç®¡ç†å‘˜å¯†ç </label>
                    <input type="password" id="settingAdminPassword" placeholder="admin123">
                </div>
                <div class="form-group">
                    <label>æœ€å¤§è¯·æ±‚å¤§å°</label>
                    <input type="text" id="settingMaxRequestSize" placeholder="50mb">
                </div>
            </div>

            <div class="card">
                <h3>æ¨¡å‹é»˜è®¤å‚æ•°</h3>
                <div class="form-group">
                    <label>æ¸©åº¦</label>
                    <input type="number" id="settingTemperature" step="0.1" min="0" max="2" placeholder="1">
                </div>
                <div class="form-group">
                    <label>Top P</label>
                    <input type="number" id="settingTopP" step="0.01" min="0" max="1" placeholder="0.85">
                </div>
                <div class="form-group">
                    <label>Top K</label>
                    <input type="number" id="settingTopK" min="1" placeholder="50">
                </div>
                <div class="form-group">
                    <label>æœ€å¤§ä»¤ç‰Œæ•°</label>
                    <input type="number" id="settingMaxTokens" min="1" placeholder="8096">
                </div>
            </div>

            <div class="card">
                <h3>ç³»ç»ŸæŒ‡ä»¤</h3>
                <div class="form-group">
                    <label>ç³»ç»ŸæŒ‡ä»¤</label>
                    <textarea id="settingSystemInstruction" rows="5"
                        placeholder="è¾“å…¥ç³»ç»ŸæŒ‡ä»¤..."></textarea>
                </div>
            </div>

            <div class="flex-buttons">
                <button onclick="loadSettings()" class="btn-secondary">é‡æ–°åŠ è½½</button>
                <button onclick="saveSettings()" class="btn-success">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>

        <!-- Proxies -->
        <div id="proxies" class="tab-content">
            <div class="card">
                <h3>æ·»åŠ ä»£ç†</h3>
                <div class="form-group">
                    <label>å¿«æ·è¾“å…¥</label>
                    <input type="text" id="proxyQuickInput" placeholder="ä¾‹å¦‚ï¼šsocks5://user:pass@127.0.0.1:1080" onkeypress="if(event.key==='Enter')parseProxyUrl()">
                    <small style="color: #6b7280; display: block; margin-top: 4px;">æ”¯æŒæ ¼å¼ï¼šprotocol://[username:password@]host:portï¼ˆæŒ‰å›è½¦é”®è§£æï¼‰</small>
                </div>
                <button onclick="parseProxyUrl()" class="btn-secondary" style="margin-bottom: 15px;">è§£æå¹¶å¡«å……</button>

                <div style="border-top: 1px solid #e5e7eb; padding-top: 15px; margin-top: 15px;">
                    <div class="form-group">
                        <label>ä»£ç†åç§°</label>
                        <input type="text" id="proxyName" placeholder="ä¾‹å¦‚ï¼šé¦™æ¸¯ä»£ç†">
                    </div>
                    <div class="form-group">
                        <label>åè®®ç±»å‹</label>
                        <select id="proxyProtocol">
                            <option value="socks5">SOCKS5</option>
                            <option value="socks4">SOCKS4</option>
                            <option value="http">HTTP</option>
                            <option value="https">HTTPS</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ä¸»æœºåœ°å€</label>
                        <input type="text" id="proxyHost" placeholder="ä¾‹å¦‚ï¼š127.0.0.1">
                    </div>
                    <div class="form-group">
                        <label>ç«¯å£</label>
                        <input type="number" id="proxyPort" placeholder="ä¾‹å¦‚ï¼š1080">
                    </div>
                    <div class="form-group">
                        <label>ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="proxyUsername" placeholder="ç•™ç©ºè¡¨ç¤ºæ— éœ€è®¤è¯">
                    </div>
                    <div class="form-group">
                        <label>å¯†ç ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="password" id="proxyPassword" placeholder="ç•™ç©ºè¡¨ç¤ºæ— éœ€è®¤è¯">
                    </div>
                    <button onclick="addProxy()" class="btn-success">æ·»åŠ ä»£ç†</button>
                </div>
            </div>

            <div class="card">
                <h3>ä»£ç†åˆ—è¡¨</h3>
                <button onclick="testAllProxies()" class="btn-secondary" style="margin-bottom: 15px;">æµ‹è¯•æ‰€æœ‰ä»£ç†</button>
                <div id="proxyList">
                    <div style="text-align: center; color: #9ca3af; padding: 20px;">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- Pricing -->
        <div id="pricing" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h3 style="margin: 0;">Tokenå®šä»·ç®¡ç†</h3>
                        <p style="color: #6b7280; margin-top: 8px;">é…ç½®ä¸åŒæ¨¡å‹çš„è¾“å…¥/è¾“å‡ºtokenä»·æ ¼ï¼ˆç¾å…ƒ/ç™¾ä¸‡tokensï¼‰</p>
                    </div>
                    <div class="flex-buttons">
                        <button onclick="showAddPricingModal()" class="btn-primary">æ·»åŠ æ¨¡å‹</button>
                        <button onclick="loadPricing()" class="btn-secondary">åˆ·æ–°</button>
                        <button onclick="resetPricing()" class="btn-danger">é‡ç½®é»˜è®¤</button>
                    </div>
                </div>
                <div id="pricingList">
                    <div style="text-align: center; color: #9ca3af; padding: 20px;">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <div class="card">
                <h3>å®šä»·è¯´æ˜</h3>
                <p style="color: #6b7280; line-height: 1.8;">
                    â€¢ <strong>åŠ¨æ€å®šä»·</strong>: å¯ä¸ºæ¯ä¸ªæ¨¡å‹è®¾ç½®ç‹¬ç«‹çš„è¾“å…¥/è¾“å‡ºtokenä»·æ ¼<br>
                    â€¢ <strong>é»˜è®¤å®šä»·</strong>: æœªé…ç½®çš„æ¨¡å‹å°†ä½¿ç”¨"default"å®šä»·<br>
                    â€¢ <strong>å®æ—¶ç”Ÿæ•ˆ</strong>: ä¿®æ”¹å®šä»·åç«‹å³å¯¹æ–°è¯·æ±‚ç”Ÿæ•ˆ<br>
                    â€¢ <strong>ä»·æ ¼å•ä½</strong>: ç¾å…ƒ/ç™¾ä¸‡tokensï¼ˆ$1.25 = æ¯ç™¾ä¸‡tokensæ”¶è´¹1.25ç¾å…ƒï¼‰
                </p>
            </div>
        </div>
    </div>
    <script>
        const API_BASE = window.location.origin;
        let chatHistory = [];
        let autoRefreshIntervals = {};
        let adminToken = localStorage.getItem('adminToken') || '';

        // è·å–å¸¦è®¤è¯çš„ headers
        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'X-Admin-Token': adminToken
            };
        }

        // æ£€æŸ¥ç³»ç»Ÿåˆå§‹åŒ–çŠ¶æ€
        async function checkSystemStatus() {
            try {
                const response = await fetch(`${API_BASE}/admin/system/status`);
                const data = await response.json();

                if (!data.initialized) {
                    // æ˜¾ç¤ºåˆå§‹åŒ–ç•Œé¢
                    document.getElementById('initBox').style.display = 'block';
                    document.getElementById('loginBox').style.display = 'none';
                } else {
                    // æ˜¾ç¤ºç™»å½•ç•Œé¢
                    document.getElementById('initBox').style.display = 'none';
                    document.getElementById('loginBox').style.display = 'block';
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
                // é»˜è®¤æ˜¾ç¤ºç™»å½•ç•Œé¢
                document.getElementById('loginBox').style.display = 'block';
            }
        }

        // åˆå§‹åŒ–ç³»ç»Ÿ
        async function doInitialize() {
            const username = document.getElementById('initUsername').value.trim();
            const password = document.getElementById('initPassword').value;
            const passwordConfirm = document.getElementById('initPasswordConfirm').value;
            const errorEl = document.getElementById('initError');
            const successEl = document.getElementById('initSuccess');
            const btn = document.getElementById('initBtn');

            errorEl.textContent = '';
            successEl.style.display = 'none';

            // éªŒè¯è¾“å…¥
            if (!username) {
                errorEl.textContent = 'è¯·è¾“å…¥ç”¨æˆ·å';
                return;
            }

            if (username.length < 3 || username.length > 20) {
                errorEl.textContent = 'ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-20ä¸ªå­—ç¬¦ä¹‹é—´';
                return;
            }

            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                errorEl.textContent = 'ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿';
                return;
            }

            if (!password) {
                errorEl.textContent = 'è¯·è¾“å…¥å¯†ç ';
                return;
            }

            if (password.length < 8) {
                errorEl.textContent = 'å¯†ç é•¿åº¦è‡³å°‘8ä¸ªå­—ç¬¦';
                return;
            }

            if (password !== passwordConfirm) {
                errorEl.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'åˆå§‹åŒ–ä¸­...';

            try {
                const response = await fetch(`${API_BASE}/admin/system/initialize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    successEl.style.display = 'block';
                    errorEl.textContent = '';

                    // åˆå§‹åŒ–æˆåŠŸåï¼Œè‡ªåŠ¨ç™»å½•
                    setTimeout(async () => {
                        document.getElementById('loginUsername').value = username;
                        document.getElementById('loginPassword').value = password;
                        await checkSystemStatus();
                        await doLogin();
                    }, 1500);
                } else {
                    errorEl.textContent = data.error || 'åˆå§‹åŒ–å¤±è´¥';
                }
            } catch (error) {
                errorEl.textContent = 'åˆå§‹åŒ–å¤±è´¥: ' + error.message;
            } finally {
                btn.disabled = false;
                btn.textContent = 'åˆ›å»ºç®¡ç†å‘˜è´¦å·';
            }
        }

        // ç™»å½•
        async function doLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            const btn = document.getElementById('loginBtn2');

            if (!username) {
                errorEl.textContent = 'è¯·è¾“å…¥ç”¨æˆ·å';
                return;
            }

            if (!password) {
                errorEl.textContent = 'è¯·è¾“å…¥å¯†ç ';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'ç™»å½•ä¸­...';
            errorEl.textContent = '';

            try {
                const response = await fetch(`${API_BASE}/admin/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    adminToken = data.token;
                    localStorage.setItem('adminToken', adminToken);
                    localStorage.setItem('adminUsername', username);
                    document.getElementById('loginOverlay').classList.add('hidden');
                    loadHomeData();
                } else {
                    errorEl.textContent = data.error || 'ç™»å½•å¤±è´¥';
                }
            } catch (error) {
                errorEl.textContent = 'ç™»å½•å¤±è´¥: ' + error.message;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ç™»å½•';
            }
        }

        // ç™»å‡º
        async function doLogout() {
            try {
                await fetch(`${API_BASE}/admin/logout`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
            } catch (e) { }

            adminToken = '';
            localStorage.removeItem('adminToken');
            document.getElementById('loginOverlay').classList.remove('hidden');
            document.getElementById('loginPassword').value = '';
        }

        // éªŒè¯ä¼šè¯
        async function verifySession() {
            if (!adminToken) {
                return false;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/verify`, {
                    headers: { 'X-Admin-Token': adminToken }
                });
                return response.ok;
            } catch (e) {
                return false;
            }
        }

        // å¸¦è®¤è¯çš„ fetch å°è£…
        async function authFetch(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: {
                    ...options.headers,
                    'X-Admin-Token': adminToken
                }
            });

            if (response.status === 401) {
                doLogout();
                throw new Error('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
            }

            return response;
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));

            // æ·»åŠ activeç±»åˆ°é€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }

            // æ‰¾åˆ°å¹¶æ¿€æ´»å¯¹åº”çš„å¯¼èˆªæŒ‰é’®
            const activeButton = document.querySelector(`.nav-tab[onclick*="'${tabName}'"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }

            // åŠ è½½å¯¹åº”æ•°æ®
            if (tabName === 'tokens') loadTokens();
            if (tabName === 'keys') loadKeys();
            if (tabName === 'logs') loadLogs();
            if (tabName === 'home') loadHomeData();
            if (tabName === 'test') loadModels();
            if (tabName === 'settings') loadSettings();
            if (tabName === 'proxies') loadProxies();
            if (tabName === 'pricing') loadPricing();
        }

        // è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
        function toggleAutoRefresh(type) {
            const checkbox = document.getElementById(`autoRefresh${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const intervalId = `${type}Interval`;

            if (checkbox.checked) {
                // å¯åŠ¨è‡ªåŠ¨åˆ·æ–° (æ¯5ç§’)
                if (type === 'logs') {
                    autoRefreshIntervals[intervalId] = setInterval(loadLogs, 5000);
                } else if (type === 'monitor') {
                    autoRefreshIntervals[intervalId] = setInterval(loadMonitorData, 5000);
                }
            } else {
                // åœæ­¢è‡ªåŠ¨åˆ·æ–°
                if (autoRefreshIntervals[intervalId]) {
                    clearInterval(autoRefreshIntervals[intervalId]);
                    delete autoRefreshIntervals[intervalId];
                }
            }
        }

        // é¦–é¡µæ•°æ®
        async function loadHomeData() {
            try {
                const [keys, tokens, keyStats, tokenStats] = await Promise.all([
                    authFetch(`${API_BASE}/admin/keys`).then(r => r.json()),
                    authFetch(`${API_BASE}/admin/tokens`).then(r => r.json()),
                    authFetch(`${API_BASE}/admin/keys/stats`).then(r => r.json()).catch(() => ({ totalRequests: 0 })),
                    authFetch(`${API_BASE}/admin/tokens/stats`).then(r => r.json()).catch(() => ({ enabled: 0, disabled: 0 }))
                ]);

                document.getElementById('keyCount').textContent = keys.length;
                document.getElementById('tokenCount').textContent = tokens.length;

                // æ›´æ–°è¯¦ç»†ç»Ÿè®¡
                document.getElementById('keyRequests').textContent = keyStats.totalRequests || 0;
                document.getElementById('tokenEnabled').textContent = tokenStats.enabled || 0;
                document.getElementById('tokenDisabled').textContent = tokenStats.disabled || 0;

                // åŠ è½½ç›‘æ§æ•°æ®
                loadMonitorData();
            } catch (error) {
                console.error('åŠ è½½é¦–é¡µæ•°æ®å¤±è´¥:', error);
            }
        }

        // Token ç®¡ç†
        async function triggerGoogleLogin() {
            const btn = document.getElementById('loginBtn');
            const resultEl = document.getElementById('loginResult');

            btn.disabled = true;
            btn.textContent = 'ç™»å½•ä¸­...';
            resultEl.innerHTML = '<div class="alert alert-info">æ­£åœ¨å¯åŠ¨ç™»å½•æµç¨‹...</div>';

            try {
                const response = await authFetch(`${API_BASE}/admin/tokens/login`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success && data.authUrl) {
                    resultEl.innerHTML = `
            <div class="alert alert-success">
              <p><strong>ç™»å½•æµç¨‹å·²å¯åŠ¨ï¼</strong></p>
              <p style="margin: 10px 0;">è¯·åœ¨æ‰“å¼€çš„æµè§ˆå™¨çª—å£ä¸­å®Œæˆ Google æˆæƒã€‚</p>
              <a href="${data.authUrl}" target="_blank" class="btn-success" style="display: inline-block; text-decoration: none; margin-top: 10px;">ç‚¹å‡»è¿™é‡Œæ‰“å¼€æˆæƒé¡µé¢</a>
            </div>
          `;
                    // è‡ªåŠ¨æ‰“å¼€æˆæƒé¡µé¢
                    window.open(data.authUrl, '_blank');
                    // 10ç§’ååˆ·æ–°Tokenåˆ—è¡¨
                    setTimeout(() => {
                        loadTokens();
                        resultEl.innerHTML = '<div class="alert alert-info">æˆæƒå®Œæˆåï¼ŒToken å°†è‡ªåŠ¨æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚å¦‚æœªçœ‹åˆ°ï¼Œè¯·ç‚¹å‡»"åˆ·æ–°åˆ—è¡¨"æŒ‰é’®ã€‚</div>';
                    }, 10000);
                } else {
                    resultEl.innerHTML = `<div class="alert alert-error">${data.message || 'ç™»å½•å¤±è´¥'}</div>`;
                }
            } catch (error) {
                resultEl.innerHTML = `<div class="alert alert-error">ç™»å½•å¤±è´¥: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ç™»å½•è·å– Token';
            }
        }

        let selectedTokens = new Set();

        async function loadTokens() {
            try {
                const response = await authFetch(`${API_BASE}/admin/tokens`);
                const tokens = await response.json();
                const container = document.getElementById('tokenList');

                if (tokens.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ—  Token è´¦å·</div>';
                    return;
                }

                // è·å–è´¦å·åç§°
                const indices = tokens.map(t => t.index);
                let accountNames = {};
                try {
                    const detailsResponse = await authFetch(`${API_BASE}/admin/tokens/details`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ indices })
                    });
                    const details = await detailsResponse.json();
                    details.forEach(d => {
                        accountNames[d.index] = {
                            email: d.email,
                            name: d.name,
                            proxyId: d.proxyId,
                            disabledUntil: d.disabledUntil,
                            quotaExhausted: d.quotaExhausted,
                            dailyCost: d.dailyCost,
                            totalCost: d.totalCost
                        };
                    });
                } catch (e) {
                    console.error('è·å–è´¦å·åç§°å¤±è´¥:', e);
                }

                // è·å–ä»£ç†åˆ—è¡¨
                let proxies = [];
                try {
                    const proxiesResponse = await authFetch(`${API_BASE}/admin/proxies`);
                    proxies = await proxiesResponse.json();
                } catch (e) {
                    console.error('è·å–ä»£ç†åˆ—è¡¨å¤±è´¥:', e);
                }

                container.innerHTML = tokens.map(token => {
                    const accountInfo = accountNames[token.index] || { email: 'Unknown', name: 'Unknown', proxyId: null, disabledUntil: null, quotaExhausted: false, dailyCost: 0, totalCost: 0 };
                    const proxyOptions = proxies.map(p =>
                        `<option value="${p.id}" ${accountInfo.proxyId === p.id ? 'selected' : ''}>${p.name} (${p.protocol}://${p.host}:${p.port})</option>`
                    ).join('');

                    // è®¡ç®—çŠ¶æ€æ˜¾ç¤º
                    let statusBadge = '';
                    let disabledInfo = '';
                    if (accountInfo.disabledUntil) {
                        const restoreTime = new Date(accountInfo.disabledUntil);
                        const now = new Date();
                        if (restoreTime > now) {
                            statusBadge = '<span style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">é…é¢è€—å°½</span>';
                            disabledInfo = `<div style="color: #e74c3c; font-size: 0.9em; margin-top: 5px;">â° å°†äº ${restoreTime.toLocaleString('zh-CN')} è‡ªåŠ¨æ¢å¤</div>`;
                        } else {
                            statusBadge = token.enable ?
                                '<span style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">å·²å¯ç”¨</span>' :
                                '<span style="background: #95a5a6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">å·²ç¦ç”¨</span>';
                        }
                    } else {
                        statusBadge = token.enable ?
                            '<span style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">å·²å¯ç”¨</span>' :
                            '<span style="background: #95a5a6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">å·²ç¦ç”¨</span>';
                    }

                    return `
            <div class="token-item" style="padding: 10px 15px;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
                        <input type="checkbox" id="token-${token.index}" onchange="toggleTokenSelection(${token.index})" ${selectedTokens.has(token.index) ? 'checked' : ''} style="width: auto; margin: 0;">
                        <strong style="color: #2c3e50;">${accountInfo.name}</strong>
                        <span style="color: #7f8c8d; font-size: 0.9em;">(${accountInfo.email})</span>
                        ${statusBadge}
                        <span style="background: #3498db; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">ä»Šæ—¥: $${(accountInfo.dailyCost||0).toFixed(4)}</span>
                        <span style="background: #8e44ad; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">ç´¯è®¡: $${(accountInfo.totalCost||0).toFixed(4)}</span>
                    </div>
                    ${disabledInfo}
                </div>
                <div class="flex-buttons" style="margin-top: 0; gap: 5px;">
                   ${accountInfo.disabledUntil && accountInfo.quotaExhausted ?
                            `<button onclick="restoreToken(${token.index})" class="btn-success" style="padding: 4px 10px; font-size: 12px; background: #27ae60;">
                      æ¢å¤
                    </button>` : ''
                        }
                  <button onclick="toggleToken(${token.index}, ${!token.enable})" class="btn-warning" style="padding: 4px 10px; font-size: 12px;">
                    ${token.enable ? 'ç¦ç”¨' : 'å¯ç”¨'}
                  </button>
                  <button onclick="deleteToken(${token.index})" class="btn-danger" style="padding: 4px 10px; font-size: 12px;">åˆ é™¤</button>
                </div>
              </div>
              
              <div style="display: flex; gap: 15px; align-items: center; font-size: 0.9em;">
                 <div style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #666; font-family: monospace; background: #f5f5f5; padding: 4px 8px; border-radius: 4px;">${token.access_token}</div>
                 <div style="display: flex; align-items: center; gap: 5px;">
                    <label style="color: #999; font-size: 0.9em; white-space: nowrap;">ä»£ç†:</label>
                    <select onchange="setTokenProxy(${token.index}, this.value, this)" style="padding: 3px 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.9em; width: 140px;">
                        <option value="" ${!accountInfo.proxyId ? 'selected' : ''}>æ— ä»£ç†</option>
                        ${proxyOptions}
                    </select>
                 </div>
                 <div style="color: #999; font-size: 0.85em; white-space: nowrap;">
                    åˆ›å»º: ${token.created}
                 </div>
              </div>
            </div>
          `;
                }).join('');
            } catch (error) {
                document.getElementById('tokenList').innerHTML =
                    `<div class="alert alert-error">åŠ è½½ Token å¤±è´¥: ${error.message}</div>`;
            }
        }

        function toggleTokenSelection(index) {
            const checkbox = document.getElementById(`token-${index}`);
            if (checkbox && checkbox.checked) {
                selectedTokens.add(index);
            } else {
                selectedTokens.delete(index);
            }
        }

        function selectAllTokens() {
            const checkboxes = document.querySelectorAll('[id^="token-"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
                const index = parseInt(cb.id.replace('token-', ''));
                if (cb.checked) {
                    selectedTokens.add(index);
                } else {
                    selectedTokens.delete(index);
                }
            });
        }

        async function exportSelectedTokens() {
            if (selectedTokens.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„è´¦å·');
                return;
            }

            try {
                const response = await authFetch(`${API_BASE}/admin/tokens/export`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ indices: Array.from(selectedTokens) })
                });

                // ä¸‹è½½ä¸º ZIP æ–‡ä»¶
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tokens_export_${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert(`æˆåŠŸå¯¼å‡º ${selectedTokens.size} ä¸ªè´¦å·`);
            } catch (error) {
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }

        // å¯¼å…¥ Token
        async function importTokens() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.zip';

            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch(`${API_BASE}/admin/tokens/import`, {
                        method: 'POST',
                        headers: {
                            'X-Admin-Token': adminToken
                        },
                        body: formData
                    });

                    const result = await response.json();
                    if (response.ok) {
                        alert(result.message || 'å¯¼å…¥æˆåŠŸï¼');
                        loadTokens();
                    } else {
                        alert('å¯¼å…¥å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (error) {
                    alert('å¯¼å…¥å¤±è´¥: ' + error.message);
                }
            };

            input.click();
        }

        async function toggleToken(index, enable) {
            try {
                await authFetch(`${API_BASE}/admin/tokens/${index}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enable })
                });
                loadTokens();
            } catch (error) {
                alert(`${enable ? 'å¯ç”¨' : 'ç¦ç”¨'}Token å¤±è´¥: ` + error.message);
            }
        }

        async function deleteToken(index) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ª Token è´¦å·å—ï¼Ÿ')) return;
            try {
                await authFetch(`${API_BASE}/admin/tokens/${index}`, {
                    method: 'DELETE'
                });
                loadTokens();
            } catch (error) {
                alert('åˆ é™¤ Token å¤±è´¥: ' + error.message);
            }
        }

        async function restoreToken(index) {
            if (!confirm('ç¡®å®šè¦æ‰‹åŠ¨æ¢å¤æ­¤ Token çš„é…é¢é™åˆ¶å—ï¼Ÿ\n\næ³¨æ„ï¼šè¿™ä¼šç«‹å³è§£é™¤é…é¢è€—å°½çš„ç¦ç”¨çŠ¶æ€ï¼Œä½†å¦‚æœç»§ç»­ä½¿ç”¨å¯èƒ½ä¼šå†æ¬¡é‡åˆ°é…é¢é™åˆ¶ã€‚')) return;
            try {
                const response = await authFetch(`${API_BASE}/admin/tokens/${index}/restore`, {
                    method: 'POST'
                });
                const result = await response.json();
                alert(result.message || 'Token å·²æ¢å¤');
                loadTokens();
            } catch (error) {
                alert('æ¢å¤ Token å¤±è´¥: ' + error.message);
            }
        }

        // æ‰‹åŠ¨æ·»åŠ  Token
        async function addTokenManually() {
            const callbackUrl = document.getElementById('callbackUrl').value.trim();
            const btn = document.getElementById('addTokenBtn');
            const resultEl = document.getElementById('addTokenResult');

            if (!callbackUrl) {
                resultEl.innerHTML = '<div class="alert alert-error">è¯·è¾“å…¥å›è°ƒé“¾æ¥</div>';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'æ·»åŠ ä¸­...';
            resultEl.innerHTML = '<div class="alert alert-info">æ­£åœ¨å¤„ç†å›è°ƒé“¾æ¥...</div>';

            try {
                const response = await authFetch(`${API_BASE}/admin/tokens/callback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ callbackUrl })
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    resultEl.innerHTML = '<div class="alert alert-success">Token æ·»åŠ æˆåŠŸï¼</div>';
                    document.getElementById('callbackUrl').value = '';
                    loadTokens();
                } else {
                    resultEl.innerHTML = `<div class="alert alert-error">${data.error || 'æ·»åŠ å¤±è´¥'}</div>`;
                }
            } catch (error) {
                resultEl.innerHTML = `<div class="alert alert-error">æ·»åŠ å¤±è´¥: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'æ·»åŠ  Token';
            }
        }

        // åˆ‡æ¢é¢‘ç‡é™åˆ¶å­—æ®µæ˜¾ç¤º
        function toggleRateLimitFields() {
            const enabled = document.getElementById('enableRateLimit').checked;
            document.getElementById('rateLimitFields').style.display = enabled ? 'block' : 'none';
        }

        // ç”Ÿæˆå¯†é’¥
        async function generateKey() {
            const name = document.getElementById('keyName').value || 'æœªå‘½å';
            const enableRateLimit = document.getElementById('enableRateLimit').checked;

            let rateLimit = null;
            if (enableRateLimit) {
                const maxRequests = parseInt(document.getElementById('maxRequests').value) || 100;
                const windowSeconds = parseInt(document.getElementById('windowSeconds').value) || 60;
                rateLimit = {
                    enabled: true,
                    maxRequests,
                    windowMs: windowSeconds * 1000
                };
            }

            // è·å–è´¹ç”¨ä¸Šé™
            let maxBalance = parseFloat(document.getElementById('maxBalance').value);
            if (isNaN(maxBalance)) {
                maxBalance = 10; // é»˜è®¤ 10 ç¾å…ƒ
            }
            // -1 è¡¨ç¤ºæ— é™é¢åº¦
            if (maxBalance === -1) {
                maxBalance = null;
            }

            try {
                const response = await authFetch(`${API_BASE}/admin/keys/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, rateLimit, maxBalance })
                });
                const data = await response.json();
                if (data.key) {
                    const balanceInfo = data.isUnlimited ? 'æ— é™é¢åº¦' : `$${data.maxBalance}`;
                    alert(`å¯†é’¥ç”ŸæˆæˆåŠŸï¼\n\nå¯†é’¥: ${data.key}\nè´¹ç”¨ä¸Šé™: ${balanceInfo}\n\nè¯·å¦¥å–„ä¿å­˜ï¼Œæ­¤å¯†é’¥ä¸ä¼šå†æ¬¡æ˜¾ç¤ºï¼`);
                    document.getElementById('keyName').value = '';
                    document.getElementById('enableRateLimit').checked = false;
                    document.getElementById('maxBalance').value = '10';
                    toggleRateLimitFields();
                    loadKeys();
                }
            } catch (error) {
                alert('ç”Ÿæˆå¯†é’¥å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½å¯†é’¥åˆ—è¡¨
        async function loadKeys() {
            try {
                const response = await authFetch(`${API_BASE}/admin/keys`);
                const keys = await response.json();
                const listEl = document.getElementById('keyList');

                if (keys.length === 0) {
                    listEl.innerHTML = '<li style="text-align: center; color: #999;">æš‚æ— å¯†é’¥</li>';
                    return;
                }

                listEl.innerHTML = keys.map(key => {
                    const rateLimitInfo = key.rateLimit && key.rateLimit.enabled
                        ? `<span style="background: #f39c12; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">é™åˆ¶: ${key.rateLimit.maxRequests}æ¬¡/${key.rateLimit.windowMs / 1000}ç§’</span>`
                        : '<span style="background: #3498db; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">æ— é™åˆ¶</span>';

                    // ä½™é¢ä¿¡æ¯
                    const balance = key.balance || 0;
                    const maxBalance = key.maxBalance || 0;
                    const totalSpent = key.totalSpent || 0;
                    const isUnlimited = key.isUnlimited;

                    let balanceColor = '#27ae60'; // é»˜è®¤ç»¿è‰²
                    if (!isUnlimited) {
                        if (balance <= 0) {
                            balanceColor = '#e74c3c'; // çº¢è‰²
                        } else if (balance < maxBalance * 0.2) {
                            balanceColor = '#f39c12'; // æ©™è‰²
                        }
                    }

                    const balanceInfo = isUnlimited
                        ? `<span style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">æ— é™é¢åº¦</span>`
                        : `<span style="background: ${balanceColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">ä½™é¢: $${balance.toFixed(2)} / $${maxBalance.toFixed(2)}</span>`;

                    return `
            <li class="key-item">
              <div style="flex: 1;">
                <div style="margin-bottom: 10px;">
                  <strong style="color: #2c3e50; font-size: 1.1em;">${key.name}</strong>
                  ${key.lastUsed ? `<span style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">å·²ä½¿ç”¨</span>` : `<span style="background: #95a5a6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">æœªä½¿ç”¨</span>`}
                  ${rateLimitInfo}
                  ${balanceInfo}
                </div>
                <div class="key-value">${key.key}</div>
                <div style="margin-top: 8px;">
                  <small style="color: #7f8c8d;">åˆ›å»ºæ—¶é—´: ${new Date(key.created).toLocaleString()}</small>
                  ${key.lastUsed ? `<small style="color: #7f8c8d; margin-left: 15px;">ä¸Šæ¬¡ä½¿ç”¨: ${new Date(key.lastUsed).toLocaleString()}</small>` : ''}
                  ${key.requests ? `<small style="color: #7f8c8d; margin-left: 15px;">è¯·æ±‚æ¬¡æ•°: ${key.requests}</small>` : ''}
                  ${!isUnlimited ? `<small style="color: #7f8c8d; margin-left: 15px;">æ€»æ¶ˆè´¹: $${totalSpent.toFixed(6)}</small>` : ''}
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn-primary" onclick="editKeyBalance('${key.key}', ${key.maxBalance}, ${key.isUnlimited})" style="background: #3498db;">ç¼–è¾‘é¢åº¦</button>
                <button class="btn-danger" onclick="deleteKey('${key.key}')">åˆ é™¤</button>
              </div>
            </li>
          `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½å¯†é’¥å¤±è´¥:', error);
            }
        }

        // åˆ é™¤å¯†é’¥
        async function deleteKey(key) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯†é’¥å—ï¼Ÿ')) return;
            try {
                await authFetch(`${API_BASE}/admin/keys/${encodeURIComponent(key)}`, {
                    method: 'DELETE'
                });
                loadKeys();
            } catch (error) {
                alert('åˆ é™¤å¯†é’¥å¤±è´¥: ' + error.message);
            }
        }

        // ç¼–è¾‘å¯†é’¥é¢åº¦
        async function editKeyBalance(key, currentMaxBalance, isUnlimited) {
            const displayBalance = isUnlimited ? 'æ— é™' : currentMaxBalance;
            const newBalanceInput = prompt(
                `è¯·è¾“å…¥æ–°çš„ä½™é¢ä¸Šé™ï¼ˆç¾å…ƒï¼‰ï¼š\nå½“å‰é¢åº¦: ${displayBalance}\n\nè¾“å…¥ -1 æˆ– 0 è®¾ç½®ä¸ºæ— é™é¢åº¦`,
                isUnlimited ? '-1' : currentMaxBalance
            );

            if (newBalanceInput === null) return; // ç”¨æˆ·å–æ¶ˆ

            let newMaxBalance = parseFloat(newBalanceInput);
            if (isNaN(newMaxBalance)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—ï¼');
                return;
            }

            // -1 æˆ– 0 è¡¨ç¤ºæ— é™é¢åº¦
            if (newMaxBalance <= 0) {
                newMaxBalance = -1;
            }

            try {
                const response = await authFetch(`${API_BASE}/admin/keys/${encodeURIComponent(key)}/balance`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ maxBalance: newMaxBalance })
                });

                const data = await response.json();
                if (data.success) {
                    const balanceText = data.isUnlimited ? 'æ— é™é¢åº¦' : `$${data.maxBalance}`;
                    alert(`é¢åº¦æ›´æ–°æˆåŠŸï¼\næ–°é¢åº¦: ${balanceText}\nå½“å‰ä½™é¢: $${data.balance.toFixed(2)}`);
                    loadKeys();
                }
            } catch (error) {
                alert('æ›´æ–°é¢åº¦å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½æ¨¡å‹åˆ—è¡¨
        async function loadModels() {
            const select = document.getElementById('testModel');
            select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';

            try {
                // å…ˆå°è¯•ä»è®¾ç½®ä¸­è·å–é»˜è®¤APIå¯†é’¥
                let apiKey = document.getElementById('testApiKey').value;
                if (!apiKey) {
                    try {
                        const settingsResponse = await authFetch(`${API_BASE}/admin/settings`);
                        const settings = await settingsResponse.json();
                        apiKey = settings.security?.apiKey || 'sk-text';
                    } catch (e) {
                        apiKey = 'sk-text';
                    }
                }

                const response = await fetch(`${API_BASE}/v1/models`, {
                    headers: {
                        'Authorization': 'Bearer ' + apiKey
                    }
                });

                if (!response.ok) {
                    throw new Error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥');
                }

                const data = await response.json();
                if (data.data && data.data.length > 0) {
                    select.innerHTML = data.data.map(model =>
                        `<option value="${model.id}">${model.id}</option>`
                    ).join('');
                } else {
                    select.innerHTML = '<option value="gpt-4">gpt-4</option><option value="gpt-3.5-turbo">gpt-3.5-turbo</option>';
                }
            } catch (error) {
                console.error('åŠ è½½æ¨¡å‹å¤±è´¥:', error);
                // å›é€€åˆ°é»˜è®¤æ¨¡å‹
                select.innerHTML = '<option value="gpt-4">gpt-4</option><option value="gpt-3.5-turbo">gpt-3.5-turbo</option>';
            }
        }

        // å‘é€æµ‹è¯•æ¶ˆæ¯
        async function sendTestMessage() {
            const message = document.getElementById('testMessage').value;
            const model = document.getElementById('testModel').value;
            const apiKey = document.getElementById('testApiKey').value;

            if (!message) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                return;
            }

            if (!apiKey) {
                alert('è¯·è¾“å…¥ API å¯†é’¥');
                return;
            }

            if (!model) {
                alert('è¯·é€‰æ‹©æ¨¡å‹');
                return;
            }

            chatHistory.push({ role: 'user', content: message });
            displayMessage('user', message);
            document.getElementById('testMessage').value = '';

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="loading"></span> å‘é€ä¸­...';

            try {
                const response = await fetch(`${API_BASE}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model,
                        messages: chatHistory,
                        stream: true
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let assistantMessage = '';
                const messageEl = displayMessage('assistant', '');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const text = decoder.decode(value);
                    const lines = text.split('\n').filter(line => line.trim().startsWith('data: '));

                    for (const line of lines) {
                        const data = line.replace('data: ', '');
                        if (data === '[DONE]') continue;

                        try {
                            const json = JSON.parse(data);
                            const content = json.choices[0]?.delta?.content || '';
                            assistantMessage += content;
                            messageEl.textContent = assistantMessage;
                        } catch (e) { }
                    }
                }

                chatHistory.push({ role: 'assistant', content: assistantMessage });
            } catch (error) {
                displayMessage('assistant', 'é”™è¯¯: ' + error.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'å‘é€æ¶ˆæ¯';
            }
        }

        function displayMessage(role, content) {
            const container = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${role}`;
            messageEl.textContent = content;
            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
            return messageEl;
        }

        function clearChat() {
            chatHistory = [];
            document.getElementById('chatMessages').innerHTML = '';
        }

        // åŠ è½½æ—¥å¿—
        async function loadLogs() {
            try {
                const response = await authFetch(`${API_BASE}/admin/logs`);
                const logs = await response.json();
                const container = document.getElementById('logContainer');

                if (logs.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— æ—¥å¿—</div>';
                    return;
                }

                container.innerHTML = logs.map(log => {
                    let logClass = 'log-info';
                    if (log.level === 'warn') logClass = 'log-warn';
                    if (log.level === 'error') logClass = 'log-error';
                    if (log.level === 'success') logClass = 'log-success';

                    return `<div class="log-entry ${logClass}">${log.timestamp} [${log.level.toUpperCase()}] ${log.message}</div>`;
                }).join('');
            } catch (error) {
                document.getElementById('logContainer').innerHTML =
                    `<div class="alert alert-error">åŠ è½½æ—¥å¿—å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        async function clearLogs() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿ')) return;
            try {
                await authFetch(`${API_BASE}/admin/logs`, { method: 'DELETE' });
                loadLogs();
            } catch (error) {
                alert('æ¸…ç©ºæ—¥å¿—å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½ç›‘æ§æ•°æ®
        async function loadMonitorData() {
            try {
                const statusResponse = await authFetch(`${API_BASE}/admin/status`);
                const data = await statusResponse.json();

                // å°è¯•è·å– Token ä½¿ç”¨ç»Ÿè®¡ï¼ˆå¯èƒ½éœ€è¦é‡å¯æœåŠ¡å™¨æ‰å¯ç”¨ï¼‰
                let usageData = { totalTokens: 0, currentIndex: 0, totalRequests: 0, tokens: [] };
                try {
                    const usageResponse = await authFetch(`${API_BASE}/admin/tokens/usage`);
                    usageData = await usageResponse.json();
                } catch (e) {
                    console.log('Token ä½¿ç”¨ç»Ÿè®¡æš‚ä¸å¯ç”¨ï¼ˆéœ€è¦é‡å¯æœåŠ¡å™¨ï¼‰');
                }

                document.getElementById('cpuUsage').textContent = data.cpu + '%';
                document.getElementById('memoryUsage').textContent = data.memory;
                document.getElementById('uptime').textContent = data.uptime;
                document.getElementById('totalRequests').textContent = data.requests;

                // æ˜¾ç¤ºç©ºé—²çŠ¶æ€
                const idleStatusEl = document.getElementById('idleStatus');
                idleStatusEl.textContent = data.idle || 'æ´»è·ƒ';
                idleStatusEl.style.color = data.idle === 'ç©ºé—²æ¨¡å¼' ? '#f39c12' : '#27ae60';
                document.getElementById('idleTime').textContent = data.idleTime || 0;

                // æ˜¾ç¤º Token ä½¿ç”¨ç»Ÿè®¡
                const usageContainer = document.getElementById('tokenUsageStats');
                if (usageContainer) {
                    if (usageData.totalTokens === 0 || !usageData.tokens || usageData.tokens.length === 0) {
                        usageContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ—  Token è´¦å·</div>';
                    } else {
                        usageContainer.innerHTML = `
                <div style="margin-bottom: 15px;">
                  <span style="background: #667eea; color: white; padding: 5px 12px; border-radius: 4px; margin-right: 10px;">
                    æ€» Token æ•°: ${usageData.totalTokens}
                  </span>
                  <span style="background: #27ae60; color: white; padding: 5px 12px; border-radius: 4px; margin-right: 10px;">
                    å½“å‰è½®è¯¢ä½ç½®: #${usageData.currentIndex}
                  </span>
                  <span style="background: #3498db; color: white; padding: 5px 12px; border-radius: 4px;">
                    æ€»è¯·æ±‚æ•°: ${usageData.totalRequests}
                  </span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                  ${(usageData.tokens || []).map(token => `
                    <div style="padding: 15px; background: ${token.isCurrent ? '#e8f4fd' : '#f8f9fa'}; border-radius: 8px; border-left: 3px solid ${token.isCurrent ? '#3498db' : '#95a5a6'};">
                      <div style="color: #2c3e50; font-weight: 600; margin-bottom: 8px;">
                        Token #${token.index}
                        ${token.isCurrent ? '<span style="background: #3498db; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; margin-left: 5px;">å½“å‰</span>' : ''}
                      </div>
                      <div style="color: #7f8c8d; font-size: 0.9em;">
                        <div>è¯·æ±‚æ¬¡æ•°: <strong style="color: #667eea;">${token.requests}</strong></div>
                        <div>æœ€åä½¿ç”¨: ${token.lastUsed ? new Date(token.lastUsed).toLocaleString() : 'ä»æœªä½¿ç”¨'}</div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              `;
                    }
                }

                document.getElementById('systemInfo').innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #667eea;">
              <div style="color: #7f8c8d; font-size: 0.9em; margin-bottom: 5px;">Node ç‰ˆæœ¬</div>
              <div style="color: #2c3e50; font-weight: 600; font-size: 1.1em;">${data.nodeVersion}</div>
            </div>
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #3498db;">
              <div style="color: #7f8c8d; font-size: 0.9em; margin-bottom: 5px;">å¹³å°</div>
              <div style="color: #2c3e50; font-weight: 600; font-size: 1.1em;">${data.platform}</div>
            </div>
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #27ae60;">
              <div style="color: #7f8c8d; font-size: 0.9em; margin-bottom: 5px;">è¿›ç¨‹ PID</div>
              <div style="color: #2c3e50; font-weight: 600; font-size: 1.1em;">${data.pid}</div>
            </div>
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #f39c12;">
              <div style="color: #7f8c8d; font-size: 0.9em; margin-bottom: 5px;">ç³»ç»Ÿå†…å­˜</div>
              <div style="color: #2c3e50; font-weight: 600; font-size: 1.1em;">${data.systemMemory}</div>
            </div>
          </div>
        `;
            } catch (error) {
                document.getElementById('systemInfo').innerHTML =
                    `<div class="alert alert-error">åŠ è½½ç›‘æ§æ•°æ®å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½ç³»ç»Ÿè®¾ç½®
        async function loadSettings() {
            try {
                const response = await authFetch(`${API_BASE}/admin/settings`);
                const settings = await response.json();

                // å¡«å……è¡¨å•
                document.getElementById('settingPort').value = settings.server?.port || '';
                document.getElementById('settingHost').value = settings.server?.host || '';
                document.getElementById('settingApiKey').value = settings.security?.apiKey || '';
                document.getElementById('settingAdminPassword').value = settings.security?.adminPassword || '';
                document.getElementById('settingMaxRequestSize').value = settings.security?.maxRequestSize || '';
                document.getElementById('settingTemperature').value = settings.defaults?.temperature || '';
                document.getElementById('settingTopP').value = settings.defaults?.top_p || '';
                document.getElementById('settingTopK').value = settings.defaults?.top_k || '';
                document.getElementById('settingMaxTokens').value = settings.defaults?.max_tokens || '';
                document.getElementById('settingSystemInstruction').value = settings.systemInstruction || '';
            } catch (error) {
                alert('åŠ è½½è®¾ç½®å¤±è´¥: ' + error.message);
            }
        }

        // ä¿å­˜ç³»ç»Ÿè®¾ç½®
        async function saveSettings() {
            try {
                const settings = {
                    server: {
                        port: parseInt(document.getElementById('settingPort').value) || 8045,
                        host: document.getElementById('settingHost').value || '0.0.0.0'
                    },
                    security: {
                        apiKey: document.getElementById('settingApiKey').value || 'sk-text',
                        adminPassword: document.getElementById('settingAdminPassword').value || 'admin123',
                        maxRequestSize: document.getElementById('settingMaxRequestSize').value || '50mb'
                    },
                    defaults: {
                        temperature: parseFloat(document.getElementById('settingTemperature').value) || 1,
                        top_p: parseFloat(document.getElementById('settingTopP').value) || 0.85,
                        top_k: parseInt(document.getElementById('settingTopK').value) || 50,
                        max_tokens: parseInt(document.getElementById('settingMaxTokens').value) || 8096
                    },
                    systemInstruction: document.getElementById('settingSystemInstruction').value || ''
                };

                const response = await authFetch(`${API_BASE}/admin/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message || 'è®¾ç½®å·²ä¿å­˜ï¼è¯·é‡å¯æœåŠ¡å™¨ä»¥åº”ç”¨æ›´æ”¹ã€‚');
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('ä¿å­˜è®¾ç½®å¤±è´¥: ' + error.message);
            }
        }

        // ===== ä»£ç†ç®¡ç†å‡½æ•° =====

        // åŠ è½½ä»£ç†åˆ—è¡¨
        async function loadProxies() {
            try {
                const response = await authFetch(`${API_BASE}/admin/proxies`);
                const proxies = await response.json();
                const container = document.getElementById('proxyList');

                if (proxies.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— ä»£ç†é…ç½®</div>';
                    return;
                }

                container.innerHTML = proxies.map(proxy => `
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: ${proxy.enabled ? '#111827' : '#9ca3af'};">
                                    ${proxy.name}
                                    <span style="background: ${proxy.enabled ? '#10b981' : '#6b7280'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px;">
                                        ${proxy.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}
                                    </span>
                                    ${proxy.testStatus ? `
                                        <span style="background: ${proxy.testStatus === 'success' ? '#10b981' : '#ef4444'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px;">
                                            ${proxy.testStatus === 'success' ? 'âœ“ æ­£å¸¸' : 'âœ— å¤±è´¥'}
                                        </span>
                                    ` : ''}
                                </div>
                                <div style="color: #6b7280; font-size: 14px;">
                                    ${proxy.protocol}://${proxy.host}:${proxy.port}
                                    ${proxy.username ? ` (ç”¨æˆ·: ${proxy.username})` : ''}
                                </div>
                                ${proxy.lastTested ? `
                                    <div style="color: #9ca3af; font-size: 12px; margin-top: 4px;">
                                        æœ€åæµ‹è¯•: ${new Date(proxy.lastTested).toLocaleString()}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="testProxy('${proxy.id}')" class="btn-secondary" style="padding: 6px 12px; font-size: 14px;">
                                    æµ‹è¯•è¿æ¥
                                </button>
                                <button onclick="toggleProxy('${proxy.id}', ${!proxy.enabled})" class="btn-${proxy.enabled ? 'secondary' : 'success'}" style="padding: 6px 12px; font-size: 14px;">
                                    ${proxy.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                                </button>
                                <button onclick="deleteProxy('${proxy.id}')" class="btn-danger" style="padding: 6px 12px; font-size: 14px;">
                                    åˆ é™¤
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½ä»£ç†åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('proxyList').innerHTML =
                    '<div style="text-align: center; color: #ef4444; padding: 20px;">åŠ è½½å¤±è´¥</div>';
            }
        }

        // è§£æä»£ç†URLå¹¶å¡«å……è¡¨å•
        function parseProxyUrl() {
            const quickInput = document.getElementById('proxyQuickInput').value.trim();
            if (!quickInput) {
                alert('è¯·è¾“å…¥ä»£ç†URLï¼');
                return;
            }

            try {
                // æ”¯æŒçš„æ ¼å¼ï¼šprotocol://[username:password@]host:port
                // ä¾‹å¦‚ï¼šsocks5://user:pass@127.0.0.1:1080 æˆ– socks5://127.0.0.1:1080
                const urlPattern = /^(socks5|socks4|http|https):\/\/(?:([^:]+):([^@]+)@)?([^:]+):(\d+)$/;
                const match = quickInput.match(urlPattern);

                if (!match) {
                    alert('ä»£ç†URLæ ¼å¼ä¸æ­£ç¡®ï¼\næ­£ç¡®æ ¼å¼ï¼šprotocol://[username:password@]host:port\nä¾‹å¦‚ï¼šsocks5://user:pass@127.0.0.1:1080');
                    return;
                }

                const [, protocol, username, password, host, port] = match;

                // å¡«å……è¡¨å•
                document.getElementById('proxyProtocol').value = protocol;
                document.getElementById('proxyHost').value = host;
                document.getElementById('proxyPort').value = port;
                document.getElementById('proxyUsername').value = username || '';
                document.getElementById('proxyPassword').value = password || '';

                // è‡ªåŠ¨ç”Ÿæˆä»£ç†åç§°ï¼ˆå¦‚æœæ²¡æœ‰å¡«å†™ï¼‰
                if (!document.getElementById('proxyName').value) {
                    const nameParts = [protocol.toUpperCase(), host];
                    if (username) nameParts.push(username);
                    document.getElementById('proxyName').value = nameParts.join('_');
                }

                alert('ä»£ç†ä¿¡æ¯å·²è‡ªåŠ¨å¡«å……ï¼è¯·æ£€æŸ¥å¹¶æ·»åŠ ã€‚');
            } catch (error) {
                alert('è§£æä»£ç†URLå¤±è´¥: ' + error.message);
            }
        }

        // æ·»åŠ ä»£ç†
        async function addProxy() {
            try {
                const name = document.getElementById('proxyName').value;
                const protocol = document.getElementById('proxyProtocol').value;
                const host = document.getElementById('proxyHost').value;
                const port = document.getElementById('proxyPort').value;
                const username = document.getElementById('proxyUsername').value;
                const password = document.getElementById('proxyPassword').value;

                if (!name || !host || !port) {
                    alert('è¯·å¡«å†™ä»£ç†åç§°ã€ä¸»æœºåœ°å€å’Œç«¯å£ï¼');
                    return;
                }

                const response = await authFetch(`${API_BASE}/admin/proxies`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        protocol,
                        host,
                        port: parseInt(port),
                        username: username || null,
                        password: password || null,
                        enabled: true
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    alert('ä»£ç†å·²æˆåŠŸæ·»åŠ ï¼');
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('proxyQuickInput').value = '';
                    document.getElementById('proxyName').value = '';
                    document.getElementById('proxyHost').value = '';
                    document.getElementById('proxyPort').value = '';
                    document.getElementById('proxyUsername').value = '';
                    document.getElementById('proxyPassword').value = '';
                    await loadProxies();
                } else {
                    alert('æ·»åŠ ä»£ç†å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('æ·»åŠ ä»£ç†å¤±è´¥: ' + error.message);
            }
        }

        // æµ‹è¯•å•ä¸ªä»£ç†
        async function testProxy(proxyId) {
            try {
                const button = event.target;
                button.disabled = true;
                button.textContent = 'æµ‹è¯•ä¸­...';

                const response = await authFetch(`${API_BASE}/admin/proxies/${proxyId}/test`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    alert(`ä»£ç†æµ‹è¯•æˆåŠŸï¼\nå»¶è¿Ÿ: ${result.latency}ms\nçŠ¶æ€: ${result.status}`);
                } else {
                    alert(`ä»£ç†æµ‹è¯•å¤±è´¥ï¼\né”™è¯¯: ${result.message}`);
                }

                await loadProxies();
            } catch (error) {
                alert('æµ‹è¯•ä»£ç†å¤±è´¥: ' + error.message);
            } finally {
                event.target.disabled = false;
                event.target.textContent = 'æµ‹è¯•è¿æ¥';
            }
        }

        // æµ‹è¯•æ‰€æœ‰ä»£ç†
        async function testAllProxies() {
            try {
                const button = event.target;
                button.disabled = true;
                button.textContent = 'æµ‹è¯•ä¸­...';

                const response = await authFetch(`${API_BASE}/admin/proxies/test-all`, {
                    method: 'POST'
                });

                const results = await response.json();

                const successCount = results.filter(r => r.success).length;
                alert(`æ‰¹é‡æµ‹è¯•å®Œæˆï¼\næˆåŠŸ: ${successCount}/${results.length}`);

                await loadProxies();
            } catch (error) {
                alert('æµ‹è¯•ä»£ç†å¤±è´¥: ' + error.message);
            } finally {
                event.target.disabled = false;
                event.target.textContent = 'æµ‹è¯•æ‰€æœ‰ä»£ç†';
            }
        }

        // åˆ‡æ¢ä»£ç†å¯ç”¨çŠ¶æ€
        async function toggleProxy(proxyId, enabled) {
            try {
                const response = await authFetch(`${API_BASE}/admin/proxies/${proxyId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });

                const result = await response.json();
                if (response.ok) {
                    await loadProxies();
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤ä»£ç†
        async function deleteProxy(proxyId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»£ç†å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await authFetch(`${API_BASE}/admin/proxies/${proxyId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (response.ok) {
                    alert('ä»£ç†å·²åˆ é™¤');
                    await loadProxies();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // ä¸ºTokenè®¾ç½®ä»£ç†
        async function setTokenProxy(tokenIndex, proxyId, selectElement) {
            try {
                const response = await authFetch(`${API_BASE}/admin/tokens/${tokenIndex}/proxy`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ proxyId: proxyId || null })
                });

                const result = await response.json();
                if (response.ok) {
                    // æ˜¾ç¤ºä¸´æ—¶æˆåŠŸæç¤º
                    if (selectElement) {
                        const originalBg = selectElement.style.background;
                        selectElement.style.background = '#d1fae5';
                        selectElement.style.transition = 'background 0.3s';

                        setTimeout(() => {
                            selectElement.style.background = originalBg;
                        }, 1000);
                    }

                    console.log(`âœ“ Token ${tokenIndex} çš„ä»£ç†å·²${proxyId ? 'è®¾ç½®' : 'ç§»é™¤'}`);
                } else {
                    alert('è®¾ç½®ä»£ç†å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('è®¾ç½®ä»£ç†å¤±è´¥: ' + error.message);
            }
        }


        // ========== å®šä»·ç®¡ç†ç›¸å…³å‡½æ•° ==========

        // åŠ è½½å®šä»·åˆ—è¡¨
        async function loadPricing() {
            try {
                const response = await authFetch(`${API_BASE}/admin/pricing`);
                const pricing = await response.json();
                const listEl = document.getElementById('pricingList');

                if (Object.keys(pricing).length === 0) {
                    listEl.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 20px;">æš‚æ— å®šä»·é…ç½®</div>';
                    return;
                }

                const pricingHtml = Object.entries(pricing).map(([model, prices]) => {
                    const isDefault = model === 'default';
                    const canDelete = !isDefault;

                    return `
                        <div style="padding: 15px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="margin-bottom: 8px;">
                                    <strong style="color: #2c3e50; font-size: 1.1em;">${model}</strong>
                                    ${isDefault ? '<span style="background: #3498db; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">é»˜è®¤</span>' : ''}
                                </div>
                                <div style="color: #6b7280;">
                                    <span>è¾“å…¥: $${prices.input.toFixed(6)}/M tokens</span>
                                    <span style="margin-left: 20px;">è¾“å‡º: $${prices.output.toFixed(6)}/M tokens</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-primary" onclick="editPricing('${model}', ${prices.input}, ${prices.output})" style="background: #3498db;">ç¼–è¾‘</button>
                                ${canDelete ? `<button class="btn-danger" onclick="deletePricing('${model}')">åˆ é™¤</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                listEl.innerHTML = pricingHtml;
            } catch (error) {
                console.error('åŠ è½½å®šä»·å¤±è´¥:', error);
                alert('åŠ è½½å®šä»·å¤±è´¥: ' + error.message);
            }
        }

        // ç¼–è¾‘å®šä»·
        async function editPricing(model, currentInputPrice, currentOutputPrice) {
            const newInputPrice = prompt(
                `ç¼–è¾‘æ¨¡å‹ ${model} çš„è¾“å…¥tokenä»·æ ¼ï¼ˆç¾å…ƒ/ç™¾ä¸‡tokensï¼‰ï¼š\nå½“å‰ä»·æ ¼: $${currentInputPrice}/M`,
                currentInputPrice
            );

            if (newInputPrice === null) return;

            const inputPrice = parseFloat(newInputPrice);
            if (isNaN(inputPrice) || inputPrice < 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼ï¼ˆéè´Ÿæ•°ï¼‰ï¼');
                return;
            }

            const newOutputPrice = prompt(
                `ç¼–è¾‘æ¨¡å‹ ${model} çš„è¾“å‡ºtokenä»·æ ¼ï¼ˆç¾å…ƒ/ç™¾ä¸‡tokensï¼‰ï¼š\nå½“å‰ä»·æ ¼: $${currentOutputPrice}/M`,
                currentOutputPrice
            );

            if (newOutputPrice === null) return;

            const outputPrice = parseFloat(newOutputPrice);
            if (isNaN(outputPrice) || outputPrice < 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼ï¼ˆéè´Ÿæ•°ï¼‰ï¼');
                return;
            }

            try {
                const response = await authFetch(`${API_BASE}/admin/pricing/${encodeURIComponent(model)}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input: inputPrice, output: outputPrice })
                });

                const data = await response.json();
                if (data.success) {
                    alert(`å®šä»·æ›´æ–°æˆåŠŸï¼\næ¨¡å‹: ${model}\nè¾“å…¥: $${inputPrice}/M\nè¾“å‡º: $${outputPrice}/M`);
                    loadPricing();
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('æ›´æ–°å®šä»·å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæ·»åŠ å®šä»·æ¨¡æ€æ¡†
        async function showAddPricingModal() {
            const model = prompt('è¯·è¾“å…¥æ–°æ¨¡å‹åç§°ï¼ˆä¾‹å¦‚ï¼šgemini-4-proï¼‰ï¼š');
            if (!model || model.trim() === '') return;

            const inputPrice = prompt(`è¯·è¾“å…¥ ${model} çš„è¾“å…¥tokenä»·æ ¼ï¼ˆç¾å…ƒ/ç™¾ä¸‡tokensï¼‰ï¼š`, '1.25');
            if (inputPrice === null) return;

            const inputPriceNum = parseFloat(inputPrice);
            if (isNaN(inputPriceNum) || inputPriceNum < 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼ï¼ˆéè´Ÿæ•°ï¼‰ï¼');
                return;
            }

            const outputPrice = prompt(`è¯·è¾“å…¥ ${model} çš„è¾“å‡ºtokenä»·æ ¼ï¼ˆç¾å…ƒ/ç™¾ä¸‡tokensï¼‰ï¼š`, '5.0');
            if (outputPrice === null) return;

            const outputPriceNum = parseFloat(outputPrice);
            if (isNaN(outputPriceNum) || outputPriceNum < 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼ï¼ˆéè´Ÿæ•°ï¼‰ï¼');
                return;
            }

            try {
                const response = await authFetch(`${API_BASE}/admin/pricing`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: model.trim(), input: inputPriceNum, output: outputPriceNum })
                });

                const data = await response.json();
                if (data.success) {
                    alert(`æ–°æ¨¡å‹å®šä»·æ·»åŠ æˆåŠŸï¼\næ¨¡å‹: ${model}\nè¾“å…¥: $${inputPriceNum}/M\nè¾“å‡º: $${outputPriceNum}/M`);
                    loadPricing();
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('æ·»åŠ å®šä»·å¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤å®šä»·
        async function deletePricing(model) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡å‹ ${model} çš„å®šä»·å—ï¼Ÿ\nåˆ é™¤åå°†ä½¿ç”¨é»˜è®¤å®šä»·ã€‚`)) {
                return;
            }

            try {
                const response = await authFetch(`${API_BASE}/admin/pricing/${encodeURIComponent(model)}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    alert(`æ¨¡å‹ ${model} çš„å®šä»·å·²åˆ é™¤ï¼`);
                    loadPricing();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('åˆ é™¤å®šä»·å¤±è´¥: ' + error.message);
            }
        }

        // é‡ç½®æ‰€æœ‰å®šä»·ä¸ºé»˜è®¤å€¼
        async function resetPricing() {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å®šä»·ä¸ºé»˜è®¤å€¼å—ï¼Ÿ\næ­¤æ“ä½œå°†æ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰å®šä»·é…ç½®ï¼')) {
                return;
            }

            try {
                const response = await authFetch(`${API_BASE}/admin/pricing/reset`, {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.success) {
                    alert('æ‰€æœ‰å®šä»·å·²é‡ç½®ä¸ºé»˜è®¤å€¼ï¼');
                    loadPricing();
                } else {
                    alert('é‡ç½®å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('é‡ç½®å®šä»·å¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('baseUrl').textContent = API_BASE;

            // é¦–å…ˆæ£€æŸ¥ç³»ç»Ÿæ˜¯å¦å·²åˆå§‹åŒ–
            await checkSystemStatus();

            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            const isLoggedIn = await verifySession();
            if (isLoggedIn) {
                document.getElementById('loginOverlay').classList.add('hidden');
                loadHomeData();

                // åŠ è½½é»˜è®¤APIå¯†é’¥åˆ°æµ‹è¯•å­—æ®µ
                try {
                    const settingsResponse = await authFetch(`${API_BASE}/admin/settings`);
                    const settings = await settingsResponse.json();
                    if (settings.security?.apiKey) {
                        document.getElementById('testApiKey').value = settings.security.apiKey;
                    }
                } catch (e) {
                    console.error('åŠ è½½é»˜è®¤APIå¯†é’¥å¤±è´¥:', e);
                }

                loadModels();
            } else {
                document.getElementById('loginOverlay').classList.remove('hidden');
            }
        });

    </script>
</body>

</html>